seuratObject <- readRDS("/mnt/smb/ltytgat/ayliyim/MI-group/ayliyim/projects/TIPRJ0000015_MAPS/maps_crc/resources/pf_atlas/pf_atlas_seuratObject.Rds")
require(SeuratObject)
seuratObject <- SCTransform(seuratObject)
require(Seurat)
seuratObject <- SCTransform(seuratObject)
saveRDS(seuratObject, "resources/pf_atlas/pf_atlas_seuratObject.Rds")
reference_seuratObject <- seuratObject
seuratObject <- readRDS("/media/hdd1/andrewliyim/maps_crc/output/normalized/20200916-SCS50-1_normalized_SeuratObject.Rds")
## Add % mitochondrial reads
seuratObject[["percent_MT"]] <- PercentageFeatureSet(seuratObject, pattern = "^MT-")
## Add cell-cycle scoring (only if some cell cycle genes are present)
cc_genes_present <- list(
s_genes = cc.genes.updated.2019$s.genes[which(cc.genes.updated.2019$s.genes %in% rownames(seuratObject))],
g2m_genes = cc.genes.updated.2019$g2m.genes[which(cc.genes.updated.2019$g2m.genes %in% rownames(seuratObject))]
)
if (any(unlist(lapply(cc_genes_present, length)) != 0)) {
seuratObject <- CellCycleScoring(
object = seuratObject,
s.features = cc_genes_present$s_genes,
g2m.features = cc_genes_present$g2m_genes
)
}
## Add references from Human CITE-seq PF Atlas dataset.
reference_seuratObject <- readRDS(reference_rds_path)
ref_anchors <- FindTransferAnchors(
reference = reference_seuratObject,
query = seuratObject,
normalization.method = "SCT",
reference.reduction = "spca",
dims = 1:50
)
reference_seuratObject
reference_seuratObject <- RunSPCA(
reference_seuratObject,
npcs = 50,
reduction.name = "spca",
reduction.key = "SPC_",
graph = NULL,
verbose = TRUE,
seed.use = 5431
)
ref_anchors <- FindTransferAnchors(
reference = reference_seuratObject,
query = seuratObject,
normalization.method = "SCT",
reference.reduction = "pca",
dims = 1:50
)
predictions <- TransferData(anchorset = ref_anchors ,
reference = reference_seuratObject,
refdata = list(
celltype_l1 = "celltype_l1",
celltype_l2 = "celltype_l2",
celltype_l3 = "celltype_l3",
celltype_l4 = "celltype_l4")
)
seuratObject@meta.data <- seuratObject@meta.data %>%
dplyr::mutate(celltype_l1 = predictions$celltype_l1$predicted.id,
celltype_l1_score = predictions$celltype_l1$prediction.score.max,
celltype_l2 = predictions$celltype_l2$predicted.id,
celltype_l2_score = predictions$celltype_l2$prediction.score.max,
celltype_l3 = predictions$celltype_l3$predicted.id,
celltype_l3_score = predictions$celltype_l3$prediction.score.max,
celltype_l4 = predictions$celltype_l4$predicted.id,
celltype_l4_score = predictions$celltype_l4$prediction.score.max)
suppressPackageStartupMessages(library(dplyr))
seuratObject@meta.data <- seuratObject@meta.data %>%
dplyr::mutate(celltype_l1 = predictions$celltype_l1$predicted.id,
celltype_l1_score = predictions$celltype_l1$prediction.score.max,
celltype_l2 = predictions$celltype_l2$predicted.id,
celltype_l2_score = predictions$celltype_l2$prediction.score.max,
celltype_l3 = predictions$celltype_l3$predicted.id,
celltype_l3_score = predictions$celltype_l3$prediction.score.max,
celltype_l4 = predictions$celltype_l4$predicted.id,
celltype_l4_score = predictions$celltype_l4$prediction.score.max)
rownames(seuratObject@meta.data) <- colnames(seuratObject)
cell_metadata <- seuratObject@meta.data
head(cell_metadata)
