---
title: 'Supplementary Figure 6: Characterized peritoneal metastatic tumor immune infiltrate'
author: "Andrew Y.F. Li Yim"
date: '2023-07-31'
output: html_document
---

```{r libraries, include=FALSE}
library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrastr)
library(ggrepel)
library(ggpubr)
library(viridis)
```

If the snakemake pipeline was run as-is, the following files will be generated in the folder from which the pipeline was run. If not, then adjust paths accordingly.    

## Setup

### Paths

```{r paths}
base_path <- "/mnt/smb/ltytgat/ayliyim/MI-group/ayliyim/projects/TIPRJ0000015_MAPS/maps_crc"

# Subsets
seurat_hc_pf_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_SeuratObject.Rds")
seurat_crcpmp_tx_immune_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_immune_SeuratObject.Rds")
seurat_hc_pf_myeloid_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_Myeloid_SeuratObject.Rds")

# Plotting parameters
celltype_markers_xlsx <- file.path(base_path, "config/order/celltype_markers.xlsx")
pf_heatmap_order_xlsx <- file.path(base_path, "config/order/q1_pf_heatmap_order.xlsx")
```

### Import data

```{r load subsets}
seurat_hc_pf <- readRDS(seurat_hc_pf_rds)
seurat_crcpmp_tx_immune <- readRDS(seurat_crcpmp_tx_immune_rds)
seurat_hc_pf_myeloid <- readRDS(seurat_hc_pf_myeloid_rds)
```

```{r load marker genes}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
```

### Output

```{r figures}
figS7Dir <- file.path(base_path, "docs/manuscript/figures/figS7")
dir.create(figS7Dir, recursive = T)
```

### Plotting parameters

```{r plotting order}
celltype_order_l3_pf <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color),
                celltype %in% seurat_hc_pf$manual_l3) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l3_tx_immune <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color),
                celltype %in% seurat_crcpmp_tx_immune$manual_l3) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))
```

```{r colors}
tissue_colors <- c(PBMC = "#F30000", PF = "#224FBD", TX = "#855522")

manual_l3_colors_pf <- celltype_order_l3_pf$color
names(manual_l3_colors_pf) <- celltype_order_l3_pf$celltype

manual_l3_colors_tx <- celltype_order_l3_tx_immune$color
names(manual_l3_colors_tx) <- celltype_order_l3_tx_immune$celltype
```

## Figures

### Violinplot CITE HC PF CD163 colored by l3

```{r violinplot hc pf cd163cite, fig.width = 7.5, fig.height = 4}
violinplot_hc_pf_cd163cite_ggplotobj <- 
  data.frame(CB = colnames(seurat_hc_pf),
             seurat_hc_pf@meta.data,
             expr = GetAssayData(seurat_hc_pf, assay = "CITE")["Hu.CD163",],
             Feature = "CD163") %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                celltype = factor(manual_l3, levels = celltype_order_l3_pf$celltype)) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  geom_violin(trim = T, scale = "width", bounds = c(0, Inf)) +
  geom_jitter(size = 0.01) +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l3_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

pdf(file.path(figS7Dir, "violinplot_hc_pf_cd163cite.pdf"), width = 7.5, height = 4)
print(violinplot_hc_pf_cd163cite_ggplotobj)
dev.off()
```

### Violinplot GEX CRC PMP TX CD163 MRC1 colored by l3

```{r violinplot crcpmp tx cd163 mrc1, fig.width = 7.5, fig.height = 4}
violinplot_crcpmp_tx_cd163_mrc1_ggplotobj <- 
  data.frame(CB = colnames(seurat_crcpmp_tx_immune),
             seurat_crcpmp_tx_immune@meta.data,
             expr = GetAssayData(seurat_crcpmp_tx_immune, assay = "RNA")["CD163",],
             Feature = "CD163") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_immune),
                                seurat_crcpmp_tx_immune@meta.data,
                                expr = GetAssayData(seurat_crcpmp_tx_immune, assay = "RNA")["MRC1",],
                                Feature = "MRC1")) %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                celltype = factor(manual_l3, levels = celltype_order_l3_tx_immune$celltype)) %>%
  dplyr::filter(manual_l1 %in% c("T", "Myeloid")) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  geom_violin(trim = T, scale = "width", bounds = c(0, Inf)) +
  geom_jitter(size = 0.01) +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l3_colors_tx) +
  facet_wrap(~Feature, nrow = 2) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

pdf(file.path(figS7Dir, "violinplot_crcpmp_tx_cd163_mrc1.pdf"), width = 7.5, height = 6)
pdf(file.path(figS7Dir, "violinplot_crcpmp_tx_myeloid-T_cd163_mrc1.pdf"), width = 6, height = 6)
print(violinplot_crcpmp_tx_cd163_mrc1_ggplotobj)
dev.off()
```

### UMAP HC PF macrophages colored by macrophage CITE markers

Here we characterize the PF-derived CD163+ macrophages by superimposing the gene expression of the following genes on the respective UMAP configuration:
- Monocytes/Monocyte-macrophages/Macrophages (CD194)
- Monocytes/Monocyte-macrophages/Macrophages (CD195)
- Monocytes/Monocyte-macrophages/Macrophages (CD196)

```{r umap hc pf myeloid col_cxcrcitemarkers, fig.width=6, fig.height=3}
umap_hc_pf_macrophages_colcxcrcitemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_hc_pf_myeloid),
             Embeddings(seurat_hc_pf_myeloid[["wnn.umap"]]),
             seurat_hc_pf_myeloid@meta.data,
             expr = GetAssayData(seurat_hc_pf_myeloid, assay = "CITE")["Hu.CD194",],
             Feature = "CD194") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_hc_pf_myeloid),
                                  Embeddings(seurat_hc_pf_myeloid[["wnn.umap"]]),
                                  seurat_hc_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_hc_pf_myeloid, assay = "CITE")["Hu.CD195",],
                                  Feature = "CD195"))  %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_hc_pf_myeloid),
                                  Embeddings(seurat_hc_pf_myeloid[["wnn.umap"]]),
                                  seurat_hc_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_hc_pf_myeloid, assay = "CITE")["Hu.CD196",],
                                  Feature = "CD196")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD194", "CD195", "CD196"))) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        xlim(-6,11) +
        ylim(-5,8) +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

pdf(file.path(figS6Dir, "umap_hc_pf_macrophages_colcxcrcitemarkers.pdf"), width = 6, height = 3)
print(ggarrange(plotlist = umap_hc_pf_macrophages_colcxcrcitemarkers_ggplotobj_list, ncol = 3))
dev.off()
```