---
title: 'Figure 1: PerIS in homeostasis'
author: "Andrew Y.F. Li Yim"
date: '2023-07-26'
output: html_document
---

```{r libraries, include=FALSE}
library(Seurat)
library(SingleCellExperiment)
library(TSCAN)
library(ggplot2)
library(dplyr)
library(ggrastr)
library(ggrepel)
library(ggpubr)
library(viridis)
library(broom)
library(readr)
library(ggalt)
library(ggblend)
library(nlme)
library(emmeans)
library(lme4)
```

If the snakemake pipeline was run as-is, the following files will be generated in the folder from which the pipeline was run. If necessary, adjust paths accordingly.

## Setup

### Paths

```{r paths}
#base_path <- "/media/hdd1/andrewliyim/maps_crc" # local drive
base_path <- "/mnt/smb/ltytgat/ayliyim/MI-group/ayliyim/projects/TIPRJ0000015_MAPS/maps_crc" # L-drive

# Subsets
seurat_pbmc_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pbmc_SeuratObject.Rds")
seurat_pf_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_SeuratObject.Rds")
seurat_pf_myeloid_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_Myeloid_SeuratObject.Rds")
seurat_pbmc_pf_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pbmc_pf_SeuratObject.Rds")
seurat_pbmc_pf_liver_colon_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/pbmc_pf_liver_colon_SeuratObject.Rds")
seurat_pf_liver_colon_macrophages_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/pf_liver_colon_macrophages_SeuratObject.Rds")
seurat_pf_macrophages_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_macrophages_SeuratObject.Rds")
seurat_liver_macrophages_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/liver_macrophages_SeuratObject.Rds")
seurat_colon_macrophages_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/colon_macrophages_SeuratObject.Rds")
seurat_liver_mnp_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/liver_mnp_SeuratObject.Rds")
seurat_colon_mnp_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/colon_mnp_SeuratObject.Rds")

# Analyses
hc_pf_macrophages_trajectory_sce_rds <- file.path(base_path, "output/q1_pf_characterization/subsets/hc_pf_macrophages_trajectory_sce.Rds")
hc_pf_macrophages_trajectory_tscan_rootmacrophagesvcan_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pf_macrophages_trajectory_tscan_rootmacrophagesvcan.Rds")
hc_pf_macrophages_trajectory_aggregated_lines_csv <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pf_macrophages_trajectory_aggregated_lines.csv")

pfvpbmc_degs_l3_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pfvpbmc_manual_l3_deseq2_list.Rds")
pfvpbmc_fgsea_l3_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pfvpbmc_manual_l3_fgsea_list.Rds")

pfvpbmc_dacs_l2rl0_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pfvpbmc_l2rl0_dacs_list.Rds")
pfvpbmc_dacs_l3rl0_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pfvpbmc_l3rl0_dacs_list.Rds")
livervpf_dacs_l3_csv <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_livervpf_l3rl0_dacs_list.Rds")
colonvpf_dacs_l3_csv <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_colonvpf_l3rl0_dacs_list.Rds")

tam_markers_xlsx <- file.path(base_path, "config/genes_of_interest/tams_ma_2022.xlsx")
pf_macrophages_tamannotation_scores_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pf_macrophages_tamannotation_scores.Rds")
pf_macrophages_tamannotation_ranks_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pf_macrophages_tamannotation_ranks.Rds")
pf_macrophages_marker_list_rds <- file.path(base_path, "output/q1_pf_characterization/analyses/hc_pf_macrophages_marker_list.Rds")

# Plotting parameters
celltype_markers_xlsx <- file.path(base_path, "config/order/celltype_markers.xlsx")
pf_heatmap_order_xlsx <- file.path(base_path, "config/order/q1_pf_heatmap_order.xlsx")
pf_myeloid_heatmap_order_xlsx <- file.path(base_path, "config/order/q1_pf_myeloid_heatmap_order.xlsx")
pf_myeloid_markers <- readxl::read_excel(pf_myeloid_heatmap_order_xlsx)

pf_myeloid_unsupervised_heatmap_order_xlsx <- file.path(base_path, "config/order/q1_pf_myeloid_unsupervised_heatmap_order.xlsx")
pf_myeloid_unsupervised_markers <- readxl::read_excel(pf_myeloid_unsupervised_heatmap_order_xlsx)

pf_macrophages_unsupervised_heatmap_order_xlsx <- file.path(base_path, "config/order/q1_pf_macrophages_unsupervised_heatmap_order.xlsx")
pf_macrophages_unsupervised_markers <- readxl::read_excel(pf_macrophages_unsupervised_heatmap_order_xlsx)
```

### Import data

```{r load subsets}
seurat_pbmc <- readRDS(seurat_pbmc_rds)
seurat_pf <- readRDS(seurat_pf_rds)
seurat_pf_myeloid <- readRDS(seurat_pf_myeloid_rds)

seurat_pbmc_pf <- readRDS(seurat_pbmc_pf_rds)
seurat_pbmc_pf_liver_colon <- readRDS(seurat_pbmc_pf_liver_colon_rds)
seurat_pf_liver_colon_macrophages <- readRDS(seurat_pf_liver_colon_macrophages_rds)
seurat_pf_macrophages <- readRDS(seurat_pf_macrophages_rds)
seurat_liver_macrophages <- readRDS(seurat_liver_macrophages_rds)
seurat_colon_macrophages <- readRDS(seurat_colon_macrophages_rds)
seurat_liver_mnp <- readRDS(seurat_liver_mnp_rds)
seurat_colon_mnp <- readRDS(seurat_colon_mnp_rds)
```

```{r load de analyses}
pfvpbmc_degs_l3 <- readRDS(pfvpbmc_degs_l3_rds)
pfvpbmc_fgsea_l3 <- readRDS(pfvpbmc_fgsea_l3_rds)
```

```{r load da analyses}
livervpf_dacs_l3rl0 <- read.csv(livervpf_dacs_l3_csv)
colonvpf_dacs_l3rl0 <- read.csv(colonvpf_dacs_l3_csv)
pfvpbmc_dacs_l2rl0 <- readRDS(pfvpbmc_dacs_l2rl0_rds)
pfvpbmc_dacs_l3rl0 <- readRDS(pfvpbmc_dacs_l3rl0_rds)
```

```{r load trajectory analyses}
hc_pf_macrophages_trajectory_sce <- readRDS(hc_pf_macrophages_trajectory_sce_rds)
hc_pf_macrophages_trajectory_tscan_rootmacrophagesvcan <- readRDS(hc_pf_macrophages_trajectory_tscan_rootmacrophagesvcan_rds)
hc_pf_macrophages_trajectory_aggregated_lines <- read.csv(hc_pf_macrophages_trajectory_aggregated_lines_csv)
```

```{r load tam analyses}
pf_macrophages_tamannotation_scores <- readRDS(pf_macrophages_tamannotation_scores_rds)
pf_macrophages_tamannotation_ranks <- readRDS(pf_macrophages_tamannotation_ranks_rds)
```

### Plotting parameters

```{r plotting order}
manual_l1_order <- readxl::read_excel(celltype_markers_xlsx) %>%
  dplyr::filter(level == "manual_l1") %>%
  dplyr::pull(celltype) %>%
  unique()

manual_l3_order <- readxl::read_excel(celltype_markers_xlsx) %>%
  dplyr::filter(level == "manual_l3") %>%
  dplyr::pull(celltype) %>%
  unique()

manual_l4_order <- readxl::read_excel(celltype_markers_xlsx) %>%
  dplyr::filter(level == "manual_l4") %>%
  dplyr::pull(celltype) %>%
  unique()

celltype_order_l2 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l2",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l2_l3 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::mutate(celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages VCAN+", "Macrophages C1Q+", "Macrophages VCAN+C1Q+", "Macrophages SPP1+"), "Mono-macs", celltype),
                color = ifelse(celltype %in% c("Mono-macs"), "#E31A1C", color)) %>%
  unique() %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_l1 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l1",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf@meta.data[,"manual_l1"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_l2 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l2",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf@meta.data[,"manual_l2"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_l3 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf@meta.data[,"manual_l3"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_l2_l3 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf@meta.data[,"manual_l3"])) %>%
  dplyr::mutate(celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages VCAN+", "Macrophages C1Q+", "Macrophages VCAN+C1Q+", "Macrophages SPP1+"), "Mono-macs", celltype),
                color = ifelse(celltype %in% c("Mono-macs"), "#E31A1C", color)) %>%
  unique() %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_l4 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf@meta.data[,"manual_l4"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_myeloid_l3 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf_myeloid@meta.data[,"manual_l3"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_myeloid_l4 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf_myeloid@meta.data[,"manual_l4"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_pf_macrophages_l4 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                celltype %in% c("Macrophages VCAN+", "Macrophages C1Q+", "Macrophages VCAN+C1Q+", "Macrophages SPP1+"),
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(celltype %in% unique(seurat_pf_myeloid@meta.data[,"manual_l4"])) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))
```

```{r colors}
tissue_colors <- c(PF = "#224FBD", PBMC = "#F30000", Colon = "#7B3F00", Liver = "#AA336A")

manual_l1_colors_pf <- celltype_order_pf_l1$color
names(manual_l1_colors_pf) <- celltype_order_pf_l1$celltype

manual_l2_colors_pf <- celltype_order_pf_l2$color
names(manual_l2_colors_pf) <- celltype_order_pf_l2$celltype

manual_l3_colors_pf <- celltype_order_pf_l3$color
names(manual_l3_colors_pf) <- celltype_order_pf_l3$celltype

manual_l3_colors_pf <- celltype_order_pf_l3$color
names(manual_l3_colors_pf) <- celltype_order_pf_l3$celltype

manual_l2_l3_colors_pf <- celltype_order_pf_l2_l3$color
names(manual_l2_l3_colors_pf) <- celltype_order_pf_l2_l3$celltype

manual_l4_colors_pf <- celltype_order_pf_l4$color
names(manual_l4_colors_pf) <- celltype_order_pf_l4$celltype

manual_l2_l3_number_colors_pf <- celltype_order_pf_l2_l3$color
names(manual_l2_l3_number_colors_pf) <- celltype_order_pf_l2_l3$number_subset

manual_l3_number_colors_pf <- celltype_order_pf_l3$color
names(manual_l3_number_colors_pf) <- celltype_order_pf_l3$number_subset

manual_l3_number_colors_pf_myeloid <- celltype_order_pf_myeloid_l3$color
names(manual_l3_number_colors_pf_myeloid) <- celltype_order_pf_myeloid_l3$number_subset

manual_l4_number_colors_pf_myeloid <- celltype_order_pf_myeloid_l4$color
names(manual_l4_number_colors_pf_myeloid) <- celltype_order_pf_myeloid_l4$number_subset

manual_l4_number_colors_pf_macrophages <- celltype_order_pf_macrophages_l4$color
names(manual_l4_number_colors_pf_macrophages) <- celltype_order_pf_macrophages_l4$number_subset

manual_l2_colors <- celltype_order_l2$color
names(manual_l2_colors) <- celltype_order_l2$celltype
```

## Figures

### UMAP HC PF colored by l1

```{r umap hc pf col_l1, fig.width=7.5, fig.height=7.5}
umap_hc_pf_l1_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                      Embeddings(seurat_pf[["wnn.umap"]]),
                                      seurat_pf@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l1, levels = celltype_order_pf_l1$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l1$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  geom_point_rast(show.legend = F, size = 0.5, col = "black") +
  geom_point_rast(show.legend = F, size = 0.25, aes(col = celltype)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype, x = x, y = y),
                   alpha = 1, 
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l1_colors_pf) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_l1_ggplotobj)

# pdf("umap_hc_pf_l1", width = 7.5, height = 7.5)
# print(umap_hc_pf_l1_ggplotobj)
# dev.off()
```

### UMAP HC PF colored by l2/l3

```{r umap hc pf col_l2l3, fig.width=7.5, fig.height=7.5}
umap_hc_pf_coll2l3_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                           Embeddings(seurat_pf[["wnn.umap"]]),
                                           seurat_pf@meta.data) %>%
  dplyr::mutate(celltype = manual_l3,
                celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+"), "Mono-macs", celltype),
                celltype = factor(celltype, levels = celltype_order_pf_l2_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l2_l3$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype)) +
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l2_l3_colors_pf) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_coll2l3_ggplotobj)

pdf("umap_hc_pf_coll2l3_7.5x7.5_s8_ls025.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_coll2l3_ggplotobj)
dev.off()
```

### UMAP HC PF colored by l3

```{r umap hc pf col_l3, fig.width=7.5, fig.height=7.5}
umap_hc_pf_coll3_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                         Embeddings(seurat_pf[["wnn.umap"]]),
                                         seurat_pf@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype)) +
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_colors_pf) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_coll3_ggplotobj)

pdf("umap_hc_pf_coll3_7.5x7.5_s8_ls025.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_coll3_ggplotobj)
dev.off()
```

### UMAP HC PF colored by l2/l3 labeled by l2/l3

```{r umap hc pf col_l2l3 lab_l2l3, fig.width=7.5, fig.height=7.5}
umap_hc_pf_coll2l3_labl2l3_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                                   Embeddings(seurat_pf[["wnn.umap"]]),
                                                   seurat_pf@meta.data) %>%
  dplyr::mutate(celltype = as.character(manual_l3),
                celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+"), "Mono-macs", celltype),
                celltype = factor(celltype, levels = celltype_order_pf_l2_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l2_l3$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size = 8,
                   show.legend = F, 
                   label.size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l2_l3_number_colors_pf) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_coll2l3_labl2l3_ggplotobj)

pdf("umap_hc_pf_coll2l3_labl2l3_7.5x7.5_s8_ls025.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_coll2l3_labl2l3_ggplotobj)
dev.off()
```

### UMAP HC PF colored by l3 labeled by l3

```{r umap hc pf col_l3 lab_l3, fig.width=7.5, fig.height=7.5}
umap_hc_pf_coll3_labl3_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                               Embeddings(seurat_pf[["wnn.umap"]]),
                                               seurat_pf@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size = 8,
                   show.legend = F, 
                   label.size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_number_colors_pf) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_coll3_labl3_ggplotobj)

pdf("umap_hc_pf_coll3_labl3_7.5x7.5_s8_ls025.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_coll3_labl3_ggplotobj)
dev.off()
```

### UMAP HC PF colored by lineage markers

T: Hu.CD3-UCHT1 and CD3D
NK/ILC: Hu.CD56 and NCAM1
B: Hu.CD20-2H7 and MS4A1
Myeloid: Hu.CD11b and ITGAM

```{r umap hc pf col_lineage_markers, fig.width=10, fig.height=6}
umap_hc_pf_lineage_markers_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                                   Embeddings(seurat_pf[["wnn.umap"]]),
                                                   seurat_pf@meta.data,
                                                   expr = GetAssayData(seurat_pf, assay = "RNA")["CD3D",],
                                                   Feature = "CD3/CD3D",
                                                   Modality = "RNA") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD3-UCHT1",],
                                Feature = "CD3/CD3D",
                                Modality = "CITE"))  %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "RNA")["NCAM1",],
                                Feature = "CD56/NCAM1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD56",],
                                Feature = "CD56/NCAM1",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "RNA")["MS4A1",],
                                Feature = "CD20/MS4A1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD20-2H7",],
                                Feature = "CD20/MS4A1",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "RNA")["ITGAM",],
                                Feature = "CD11b/ITGAM",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                Embeddings(seurat_pf[["wnn.umap"]]),
                                seurat_pf@meta.data,
                                expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD11b",],
                                Feature = "CD11b/ITGAM",
                                Modality = "CITE")) %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                Feature = factor(Feature, levels = c("CD3/CD3D", "CD56/NCAM1", "CD20/MS4A1", "CD11b/ITGAM")),
                celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
  geom_point_rast(data = . %>%
                    dplyr::filter(expr>0), aes(col = expr, order = expr_rank), show.legend = T, size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  facet_grid(Modality~Feature, switch = "y") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_color_viridis() +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_lineage_markers_ggplotobj)

# pdf("umap_hc_pf_lineage_markers.pdf", width = 10, height=6)
# print(umap_hc_pf_lineage_markers_ggplotobj)
# dev.off()
```

```{r umap hc pf col_lineagegenemarkers, fig.width=10, fig.height=3}
umap_hc_pf_collineagegenemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf),
             Embeddings(seurat_pf[["wnn.umap"]]),
             seurat_pf@meta.data,
             expr = GetAssayData(seurat_pf, assay = "RNA")["CD3D",],
             Feature = "CD3/CD3D",
             Modality = "RNA") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "RNA")["NCAM1",],
                                  Feature = "CD56/NCAM1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "RNA")["MS4A1",],
                                  Feature = "CD20/MS4A1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "RNA")["ITGAM",],
                                  Feature = "CD11b/ITGAM",
                                  Modality = "RNA")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD3/CD3D", "CD56/NCAM1", "CD20/MS4A1", "CD11b/ITGAM")),
                  celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        #scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks = element_blank(),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_collineagegenemarkers_ggplotobj_list, nrow = 1, ncol = 4))

pdf("umap_hc_pf_collineagegenemarkers_colviridis.pdf", width = 10, height = 3)
print(ggarrange(plotlist = umap_hc_pf_collineagegenemarkers_ggplotobj_list, nrow = 1, ncol = 4))
dev.off()
```

```{r umap hc pf col_lineagecitemarkers, fig.width=10, fig.height=3}
umap_hc_pf_collineagecitemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf),
             Embeddings(seurat_pf[["wnn.umap"]]),
             seurat_pf@meta.data,
             expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD3-UCHT1",],
             Feature = "CD3/CD3D",
             Modality = "CITE")  %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD56",],
                                  Feature = "CD56/NCAM1",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD20-2H7",],
                                  Feature = "CD20/MS4A1",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf),
                                  Embeddings(seurat_pf[["wnn.umap"]]),
                                  seurat_pf@meta.data,
                                  expr = GetAssayData(seurat_pf, assay = "CITE")["Hu.CD11b",],
                                  Feature = "CD11b/ITGAM",
                                  Modality = "CITE")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD3/CD3D", "CD56/NCAM1", "CD20/MS4A1", "CD11b/ITGAM")),
                  celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        #scale_color_viridis() +
        scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.text.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks = element_blank(),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_collineagecitemarkers_ggplotobj_list, nrow = 1, ncol = 4))

pdf("umap_hc_pf_collineagecitemarkers_colrd.pdf", width = 10, height = 3)
print(ggarrange(plotlist = umap_hc_pf_collineagecitemarkers_ggplotobj_list, nrow = 1, ncol = 4))
dev.off()
```


### UMAP HC PBMC colored by donor

```{r umap hc pbmc coldonor, fig.width=7.5, fig.height=7.5}
umap_hc_pbmc_coldonor_ggplotobj <- data.frame(CB = colnames(seurat_pbmc),
                                              Embeddings(seurat_pbmc[["umap"]]),
                                              seurat_pbmc@meta.data) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, col = Donor)) +
  geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pbmc_coldonor_ggplotobj)

pdf("umap_hc_pbmc_coldonor.pdf", width = 7.5, height = 7.5)
print(umap_hc_pbmc_coldonor_ggplotobj)
dev.off()
```

### UMAP HC PF colored by donor

```{r umap hc pf coldonor, fig.width=7.5, fig.height=7.5}
umap_hc_pf_coldonor_ggplotobj <- data.frame(CB = colnames(seurat_pf),
                                            Embeddings(seurat_pf[["wnn.umap"]]),
                                            seurat_pf@meta.data) %>%
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2, col = Donor)) +
  geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_coldonor_ggplotobj)

pdf("umap_hc_pf_coldonor.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_coldonor_ggplotobj)
dev.off()
```

### UMAP HC PM-CRC PF macrophages color by Donor

```{r umap hc crcpmp pf coldonor, fig.width=5, fig.height=5}
umap_hc_crcpmp_pf_coldonor_ggplotobj <- data.frame(CB = colnames(seurat_hc_crcpmp_pf),
                                                   Embeddings(seurat_hc_crcpmp_pf[["umap"]]),
                                                   seurat_hc_crcpmp_pf@meta.data) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, col = Donor)) +
  geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_crcpmp_pf_blenddonor_ggplotobj)

pdf("umap_hc_crcpmp_pf_blenddonor.pdf", width = 7.5, height=7.5)
print(umap_hc_crcpmp_pf_blenddonor_ggplotobj)
dev.off()
```


### Heatmap PEX HC PF colored by l2/l3

```{r heatmap pex hc pf col_cellmarkers l2 l3, fig.width=8.75, fig.height=9}
marker_proteins <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "CITE")

seurat_pf_l2l3 <- seurat_pf

seurat_pf_l2l3@meta.data <- seurat_pf_l2l3@meta.data %>%
  dplyr::mutate(celltype = manual_l3,
                celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+"), "Mono-macs", as.character(celltype)),
                celltype = factor(celltype, levels = celltype_order_pf_l2_l3$celltype))

Idents(seurat_pf_l2l3) <- "celltype"
seurat_pf_l2l3_avexpr <- AverageExpression(seurat_pf_l2l3, return.seurat = T)

marker_avepexprl2l3_pex <- GetAssayData(seurat_pf_l2l3_avexpr, assay = "CITE")[marker_proteins$FeatureID, ]

heatmap_hc_pf_l2l3_cellmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(marker_avepexprl2l3_pex, 
                                                                                 color = PurpleAndYellow(1000),
                                                                                 labels_row = marker_proteins$protein,
                                                                                 cluster_rows = F, 
                                                                                 cluster_cols = F, 
                                                                                 scale = "row",
                                                                                 name = "Scaled median")

print(heatmap_hc_pf_l2l3_cellmarkers_pex_complexheatmapobj)

# #pdf("heatmap_hc_pf_cellmarkers_pex.pdf", width = 6.5, height = 6.25)
pdf("heatmap_hc_pf_l2l3_cellmarkers_pex.pdf", width = 8.75, height = 9)
print(heatmap_hc_pf_l2l3_cellmarkers_pex_complexheatmapobj)
dev.off()
```

### Dotplot GEX HC PF colored by l2/l3

```{r dotplot gex hc pf col_l2l3, fig.width = 7.25, fig.height=15}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
marker_gex <- GetAssayData(seurat_pf_l2l3, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_l2l3, assay = "RNA")) %in% unique(marker_genes$FeatureID)), ]

dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_l2l3@meta.data), 
                               Celltype = seurat_pf_l2l3@meta.data[,"celltype"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, celltype_order_pf_l2_l3$celltype),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj)

pdf("dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj.pdf", width = 7.5, height=15)
print(dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj)
dev.off()
```

```{r dotplot gex overlapping hc pf col_l2l3, fig.width = 7, fig.height=9}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
marker_gex <- GetAssayData(seurat_pf, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_l2l3, assay = "RNA")) %in% unique(marker_genes$FeatureID)), ]

dotplot_hc_pf_l2l3_cellmarkers_gex_overlapping_ggplotobj <- data.frame(
  FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_l2l3@meta.data), 
                               Celltype = seurat_pf_l2l3@meta.data[,"celltype"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, celltype_order_pf_l2_l3$celltype),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  dplyr::filter(FeatureID %in% marker_proteins$gene) %>%
  #dplyr::filter(Percentage != 0) %>%
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_l2l3_cellmarkers_gex_overlapping_ggplotobj)

# #pdf("dotplot_hc_pf_cellmarkers_gex_overlapping.pdf", width = 5.75, height=7.5)
pdf("dotplot_hc_pf_l2l3_cellmarkers_gex_overlapping.pdf", width = 7, height=9)
print(dotplot_hc_pf_l2l3_cellmarkers_gex_overlapping_ggplotobj)
dev.off()
```

### Dotplot GEX HC PBMC colored by l3

```{r dotplot gex hc pbmc col_cellmarkers, fig.width = 7.25, fig.height=15}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
marker_gex <- GetAssayData(seurat_pbmc, assay = "RNA")[which(rownames(GetAssayData(seurat_pbmc, assay = "RNA")) %in% unique(marker_genes$FeatureID)), ]

dotplot_hc_pbmc_cellmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pbmc@meta.data), 
                               Celltype = seurat_pbmc@meta.data[,"manual_l3"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pbmc_cellmarkers_gex_ggplotobj)

pdf("dotplot_hc_pbmc_cellmarkers_gex_ggplotobj.pdf", width = 6, height=15)
print(dotplot_hc_pbmc_cellmarkers_gex_ggplotobj)
dev.off()
```

### Heatmap PEX HC PF colored by l3

```{r heatmap pex hc pf col_cellmarkers, fig.width=8.75, fig.height=9}
marker_proteins <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "CITE")

seurat_pf@meta.data$manual_l3 <- factor(seurat_pf@meta.data$manual_l3, levels = celltype_order_pf_l3$celltype)

Idents(seurat_pf) <- "manual_l3"
seurat_pf_avexprl3 <- AverageExpression(seurat_pf, return.seurat = T)

marker_avepexprl3_pex <- GetAssayData(seurat_pf_avexprl3, assay = "CITE")[marker_proteins$FeatureID, ]

heatmap_hc_pf_cellmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(marker_avepexprl3_pex, 
                                                                            color = PurpleAndYellow(1000),
                                                                            labels_row = marker_proteins$protein,
                                                                            cluster_rows = F, 
                                                                            cluster_cols = F, 
                                                                            scale = "row",
                                                                            name = "Scaled median")

print(heatmap_hc_pf_cellmarkers_pex_complexheatmapobj)

# #pdf("heatmap_hc_pf_cellmarkers_pex.pdf", width = 6.5, height = 6.25)
# pdf("heatmap_hc_pf_cellmarkers_pex.pdf", width = 8.75, height = 9)
# print(heatmap_hc_pf_cellmarkers_pex_complexheatmapobj)
# dev.off()
```

### Dotplot GEX HC PF colored by l3

```{r dotplot gex hc pf col_cellmarkers, fig.width = 7.25, fig.height=15}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
marker_gex <- GetAssayData(seurat_pf, assay = "RNA")[which(rownames(GetAssayData(seurat_pf, assay = "RNA")) %in% unique(marker_genes$FeatureID)), ]

dotplot_hc_pf_cellmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf@meta.data), 
                               Celltype = seurat_pf@meta.data[,"manual_l3"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_cellmarkers_gex_ggplotobj)

# pdf("dotplot_hc_pf_cellmarkers_gex_ggplotobj.pdf", width = 6, height=15)
# print(dotplot_hc_pf_cellmarkers_gex_ggplotobj)
# dev.off()
```

```{r dotplot gex overlapping hc pf col_l3, fig.width = 7, fig.height=9}
dotplot_hc_pf_cellmarkers_gex_overlapping_ggplotobj <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf@meta.data), 
                               Celltype = seurat_pf@meta.data[,"manual_l3"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  dplyr::filter(FeatureID %in% marker_proteins$gene) %>%
  #dplyr::filter(Percentage != 0) %>%
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_cellmarkers_gex_overlapping_ggplotobj)

# #pdf("dotplot_hc_pf_cellmarkers_gex_overlapping.pdf", width = 5.75, height=7.5)
# pdf("dotplot_hc_pf_cellmarkers_gex_overlapping.pdf", width = 7, height=9)
# print(dotplot_hc_pf_cellmarkers_gex_overlapping_ggplotobj)
# dev.off()
```

### Scatterplot correlation PEX GEX

```{r scatterplot pex gex overlapping hc pf col_l1, fig.width = 7, fig.height=7}
marker_pex <- GetAssayData(seurat_pf, assay = "CITE")[which(rownames(GetAssayData(seurat_pf, assay = "CITE")) %in% unique(marker_proteins$FeatureID)), ]

marker_gex_mean <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf@meta.data), 
                               Lineage = seurat_pf@meta.data[,"manual_l1"],
                               Celltype = seurat_pf@meta.data[,"manual_l3"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Lineage, Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Mean = mean(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Mean = ifelse(is.na(Mean), 0, Mean),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID)),
                Modality = "GEX")

marker_pex_mean <- data.frame(FeatureID = rownames(marker_pex), marker_pex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf@meta.data), 
                               Celltype = seurat_pf@meta.data[,"manual_l3"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Mean = mean(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Mean = ifelse(is.na(Mean), 0, Mean),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(marker_proteins$FeatureID)),
                Modality = "PEX") %>%
  dplyr::left_join(marker_proteins, by = "FeatureID")


marker_gex_pex_mean <- marker_pex_mean %>%
  dplyr::left_join(marker_gex_mean, by = c("gene" = "FeatureID",
                                           "Celltype")) %>%
  dplyr::rename(Mean_pex = Mean.x,
                Mean_gex = Mean.y,
                Percentage_gex = Percentage.x,
                Percentage_pex = Percentage.y,
                Modality_gex = Modality.x,
                Modality_pex = Modality.y)

scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_ggplotobj <- marker_gex_pex_mean %>%
  dplyr::filter(Mean_pex != 0,
                Mean_gex != 0) %>%
  ggplot(aes(x = Mean_pex, y = Mean_gex, col = Lineage)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point_rast() +
  geom_smooth(method=lm, se = F) +
  labs(title = "Correlation mean expression",
       x = "Protein expression",
       y = "Gene expression") +
  theme_bw() +
  scale_color_manual(values = manual_l1_colors_pf) +
  theme(legend.position = "bottom", 
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

print(scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_ggplotobj)

pdf("scatterplot_hc_pf_cellmarkers_pex_gex_overlapping.pdf", width = 7, height=9)
print(scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_ggplotobj)
dev.off()

scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_split_ggplotobj <- marker_gex_pex_mean %>%
  dplyr::filter(Mean_pex != 0,
                Mean_gex != 0) %>%
  ggplot(aes(x = Mean_pex, y = Mean_gex, col = Lineage)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point_rast() +
  geom_smooth(method=lm, se = F) +
  labs(title = "Correlation mean expression",
       x = "Protein expression",
       y = "Gene expression") +
  facet_wrap(~Lineage, nrow = 2, ncol = 2) +
  theme_bw() +
  scale_color_manual(values = manual_l1_colors_pf) +
  theme(legend.position = "bottom", 
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

print(scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_split_ggplotobj)

pdf("scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_split.pdf", width = 7, height=9)
print(scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_split_ggplotobj)
dev.off()

marker_gex_pex_mean %>%
  dplyr::filter(Mean_pex != 0,
                Mean_gex != 0) %>%
  dplyr::group_by(Lineage) %>% 
  do(tidy(cor.test(.$Mean_gex, .$Mean_pex, method = "pearson"))) %>%
  write_delim("scatterplot_hc_pf_cellmarkers_pex_gex_overlapping_lm_pearson.csv", delim = ",")
```

### UMAP HC PF Myeloid colored manual_l3

```{r umap hc pf col_l3, fig.width=7.5, fig.height=7.5}
umap_hc_pf_myeloid_coll3_ggplotobj <- data.frame(CB = colnames(seurat_pf_myeloid),
                                                 Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                                 seurat_pf_myeloid@meta.data) %>%
  dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_myeloid_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_myeloid_l3$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1, 
                   size = 8,
                   show.legend = F,
                   label.size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_number_colors_pf_myeloid) +
  xlim(-6,11) +
  ylim(-5,8) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_myeloid_coll3_ggplotobj)

pdf("umap_hc_pf_myeloid_coll3_7.5x7.5_s8_ls0.25.pdf", width = 7.5, height = 7.5)
print(umap_hc_pf_myeloid_coll3_ggplotobj)
dev.off()
```

### UMAP HC PF Myeloid colored manual_l4

```{r umap hc pf col_l4, fig.width=7.5, fig.height=7.5}
umap_hc_pf_myeloid_coll4_ggplotobj <- data.frame(CB = colnames(seurat_pf_myeloid),
                                                 Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                                 seurat_pf_myeloid@meta.data) %>%
  # dplyr::mutate(manual_l4 = ifelse(manual_l3 == "Macrophages VCAN+" & CellID %in% seurat_pf_myeloid@meta.data$CellID[which(GetAssayData(seurat_pf_myeloid, assay = "RNA")[c("SPP1"),]>0)], "Macrophages VCAN+SPP1+", manual_l4),
  #               manual_l4 = ifelse(manual_l3 == "Macrophages C1Q+" & CellID %in% seurat_pf_myeloid@meta.data$CellID[which(GetAssayData(seurat_pf_myeloid, assay = "RNA")[c("SPP1"),]>0)], "Macrophages C1Q+SPP1+", manual_l4)) %>%
  #dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_pf_myeloid_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_myeloid_l4$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1, 
                   size = 8,
                   show.legend = F,
                   label.size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_number_colors_pf_myeloid) +
  xlim(-6,11) +
  ylim(-5,8) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_myeloid_coll4_ggplotobj)

#pdf("umap_hc_pf_myeloid_coll4_7.5x7.5_s8_ls0.25.pdf", width = 7.5, height = 7.5)
pdf("umap_hc_pf_myeloid_coll4_4x5_s8_ls0.25.pdf", width = 4, height = 5)
print(umap_hc_pf_myeloid_coll4_ggplotobj)
dev.off()
```

### Boxplot HC PF Myeloid l4rl1

```{r boxplot hc pf myeloid l4rl1, fig.width=7.5, fig.height=7.5}
boxplot_hc_pf_myeloid_l4rl1_ggplotobj <- seurat_pf_myeloid@meta.data %>%
  dplyr::filter(!manual_l2 %in% c("Granulocytes")) %>%
  dplyr::group_by(manual_l4, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l4, -Ncellperc), y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%MNPs") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pf_myeloid_l4rl1_ggplotobj)

pdf("boxplot_hc_pf_myeloid_l4rl1_4x5_s8_ls0.25.pdf", width = 4, height = 5)
print(boxplot_hc_pf_myeloid_l4rl1_ggplotobj)
dev.off()

seurat_pf_myeloid@meta.data %>%
  dplyr::filter(!manual_l2 %in% c("Granulocytes")) %>%
  dplyr::group_by(manual_l4, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  write_csv(file = "hc_pf_l4rMNPs.csv")
```

### Boxplot HC PF Myeloid l4rl1

```{r boxplot hc pf myeloid l4rl1, fig.width=7.5, fig.height=7.5}
boxplot_hc_pf_macrophages_l4rl2_ggplotobj <- seurat_pf_macrophages@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l4, -Ncellperc), y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%Macrophages") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pf_macrophages_l4rl2_ggplotobj)

pdf("boxplot_hc_pf_macrophages_l4rl2_4x5_s8_ls0.25.pdf", width = 4, height = 5)
print(boxplot_hc_pf_macrophages_l4rl2_ggplotobj)
dev.off()

seurat_pf_macrophages@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  write_csv(file = "hc_pf_macrophages_l4rl2.csv")
```

### UMAP HC PF Myeloid colored by myeloid gene markers

```{r umap hc pf col_myeloidgenemarkers, fig.width=12, fig.height=12}
umap_hc_pf_myeloid_colmyeloidgenemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_myeloid),
             Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
             seurat_pf_myeloid@meta.data,
             expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD1C",],
             Feature = "CD1C",
             Modality = "RNA") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CLEC9A",],
                                  Feature = "CLEC9A",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CLEC4C",],
                                  Feature = "CLEC4C",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["VCAN",],
                                  Feature = "VCAN",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["VSIG4",],
                                  Feature = "VSIG4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["TREM2",],
                                  Feature = "TREM2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["FN1",],
                                  Feature = "FN1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CSF1R",],
                                  Feature = "CSF1R",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["ITGAM",],
                                  Feature = "ITGAM",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["ITGAX",],
                                  Feature = "ITGAX",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD14",],
                                  Feature = "CD14",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["GATA6",],
                                  Feature = "GATA6",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["TIMD4",],
                                  Feature = "TIMD4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["MRC1",],
                                  Feature = "MRC1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CCR2",],
                                  Feature = "CCR2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["LYVE1",],
                                  Feature = "LYVE1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["XCR1",],
                                  Feature = "XCR1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["S100A8",],
                                  Feature = "S100A8",
                                  Modality = "RNA")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD1C", "CLEC9A", "CLEC4C", "SPP1", "MARCO", "CD163", "VCAN", "C1QA", "VSIG4", "TREM2", "FN1", "CSF1R", "ITGAM", "ITGAX", "CD14", "GATA6", "TIMD4", "MRC1", "CCR2", "LYVE1", "XCR1", "S100A8")),
                  celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        xlim(-6,11) +
        ylim(-5,8) +
        scale_color_viridis() +
        #scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              # axis.text.x = element_blank(),
              # axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              # axis.text.y = element_blank(),
              # axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_myeloid_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))

pdf("umap_hc_pf_myeloid_colmyeloidgenemarkers_colviridis.pdf", width = 15, height = 15)
print(ggarrange(plotlist = umap_hc_pf_myeloid_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))
dev.off()
```

### Violinplots HC PF Myeloid facetted by myeloid gene markers

```{r violinplot hc pf fac_myeloidgenemarkers, fig.width=3, fig.height=15}
violinplot_hc_pf_myeloid_myeloidgenemarker_ggplotobj <- 
  data.frame(CB = colnames(seurat_pf_myeloid),
             Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
             seurat_pf_myeloid@meta.data,
             expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD1C",],
             Feature = "CD1C",
             Modality = "RNA") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CLEC9A",],
                                Feature = "CLEC9A",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CLEC4C",],
                                Feature = "CLEC4C",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["SPP1",],
                                Feature = "SPP1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["MARCO",],
                                Feature = "MARCO",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD163",],
                                Feature = "CD163",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["VCAN",],
                                Feature = "VCAN",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["C1QA",],
                                Feature = "C1QA",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["VSIG4",],
                                Feature = "VSIG4",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["TREM2",],
                                Feature = "TREM2",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["FN1",],
                                Feature = "FN1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CSF1R",],
                                Feature = "CSF1R",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["ITGAM",],
                                Feature = "ITGAM",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["ITGAX",],
                                Feature = "ITGAX",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD14",],
                                Feature = "CD14",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["GATA6",],
                                Feature = "GATA6",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["TIMD4",],
                                Feature = "TIMD4",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["MRC1",],
                                Feature = "MRC1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CCR2",],
                                Feature = "CCR2",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["LYVE1",],
                                Feature = "LYVE1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["XCR1",],
                                Feature = "XCR1",
                                Modality = "RNA")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["S100A8",],
                                Feature = "S100A8",
                                Modality = "RNA")) %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                Feature = factor(Feature, levels = c("CD1C", "CLEC9A", "CLEC4C", "SPP1", "MARCO", "CD163", "VCAN", "C1QA", "VSIG4", "TREM2", "FN1", "CSF1R", "ITGAM", "ITGAX", "CD14", "GATA6", "TIMD4", "MRC1", "CCR2", "LYVE1", "XCR1", "S100A8")),
                celltype = factor(manual_l4, levels = celltype_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l4$number_subset)) %>%
  dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~Feature, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_myeloid_myeloidgenemarker_ggplotobj)

pdf("violinplot_hc_pf_myeloid_myeloidgenemarker.pdf", width = 4, height = 20)
print(violinplot_hc_pf_myeloid_myeloidgenemarker_ggplotobj)
dev.off()
```

### UMAP HC PF Myeloid colored by myeloid CITE markers

```{r umap hc pf col_myeloidcitemarkers, fig.width=12, fig.height=12}
umap_hc_pf_myeloid_colmyeloidcitemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_myeloid),
             Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
             seurat_pf_myeloid@meta.data,
             expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD1c",],
             Feature = "CD1C",
             Modality = "CITE") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD163",],
                                  Feature = "CD163",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD14-M5E2",],
                                  Feature = "CD14",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD192",],
                                  Feature = "CD192",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                  seurat_pf_myeloid@meta.data,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD115",],
                                  Feature = "CD115",
                                  Modality = "CITE")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD1C", "CD163", "CD14", "CD192", "CD115")),
                  celltype = factor(manual_l4, levels = celltype_order_pf_l4$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l4$number_subset)) %>%
    dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% 
        dplyr::arrange(expr) %>%
        ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        xlim(-6,11) +
        ylim(-5,8) +
        #scale_color_viridis() +
        scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              # axis.text.x = element_blank(),
              # axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              # axis.text.y = element_blank(),
              # axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_myeloid_colmyeloidcitemarkers_ggplotobj_list, nrow = 1, ncol = 5))

pdf("umap_hc_pf_myeloid_colmyeloidcitemarkers_colrd.pdf", width = 15, height = 3)
print(ggarrange(plotlist = umap_hc_pf_myeloid_colmyeloidcitemarkers_ggplotobj_list, nrow = 1, ncol = 5))
dev.off()
```

### Violinplots HC PF Myeloid facetted by myeloid CITE markers

```{r violinplot hc pf fac_myeloidcitemarkers, fig.width=3, fig.height=15}
violinplot_hc_pf_myeloid_myeloidcitemarker_ggplotobj <- 
  data.frame(CB = colnames(seurat_pf_myeloid),
             Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
             seurat_pf_myeloid@meta.data,
             expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD1c",],
             Feature = "CD1C",
             Modality = "CITE") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD163",],
                                Feature = "CD163",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD14-M5E2",],
                                Feature = "CD14",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                seurat_pf_myeloid@meta.data,
                                expr = GetAssayData(seurat_pf_myeloid, assay = "CITE")["Hu.CD192",],
                                Feature = "CD192",
                                Modality = "CITE")) %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                Feature = factor(Feature, levels = c("CD1C", "CD163", "CD14", "CD192")),
                celltype = factor(manual_l4, levels = celltype_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l4$number_subset)) %>%
  dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~Feature, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_myeloid_myeloidcitemarker_ggplotobj)

pdf("violinplot_hc_pf_myeloid_myeloidcitemarker.pdf", width = 4, height = 4)
print(violinplot_hc_pf_myeloid_myeloidcitemarker_ggplotobj)
dev.off()
```

### UMAP HC PF macrophages colored by myeloid gene markers

```{r umap hc pf macrophages col_myeloidgenemarkers, fig.width=12, fig.height=12}
umap_hc_pf_macrophages_colmyeloidgenemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_macrophages),
             Embeddings(seurat_pf_macrophages[["gex.umap"]]),
             seurat_pf_macrophages@meta.data,
             expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD1C",],
             Feature = "CD1C",
             Modality = "RNA") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CLEC9A",],
                                  Feature = "CLEC9A",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["VCAN",],
                                  Feature = "VCAN",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["VSIG4",],
                                  Feature = "VSIG4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["TREM2",],
                                  Feature = "TREM2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["FN1",],
                                  Feature = "FN1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CSF1R",],
                                  Feature = "CSF1R",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["ITGAM",],
                                  Feature = "ITGAM",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["ITGAX",],
                                  Feature = "ITGAX",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD14",],
                                  Feature = "CD14",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["GATA6",],
                                  Feature = "GATA6",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["TIMD4",],
                                  Feature = "TIMD4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["MRC1",],
                                  Feature = "MRC1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CCR2",],
                                  Feature = "CCR2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["LYVE1",],
                                  Feature = "LYVE1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["XCR1",],
                                  Feature = "XCR1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["S100A8",],
                                  Feature = "S100A8",
                                  Modality = "RNA")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD1C", "CLEC9A", "SPP1", "MARCO", "CD163", "VCAN", "C1QA", "VSIG4", "TREM2", "FN1", "CSF1R", "ITGAM", "ITGAX", "CD14", "GATA6", "TIMD4", "MRC1", "CCR2", "LYVE1", "XCR1", "S100A8")),
                  celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = gexUMAP_1, y = gexUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        #scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              # axis.text.x = element_blank(),
              # axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              # axis.text.y = element_blank(),
              # axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_macrophages_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))

pdf("umap_hc_pf_macrophages_colmyeloidgenemarkers_colviridis.pdf", width = 15, height = 15)
print(ggarrange(plotlist = umap_hc_pf_macrophages_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))
dev.off()
```

### UMAP HC PF macrophages colored by myeloid CITE markers

```{r umap hc pf macrophages col_myeloidcitemarkers, fig.width=12, fig.height=3}
umap_hc_pf_macrophages_colmyeloidcitemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_macrophages),
             Embeddings(seurat_pf_macrophages[["gex.umap"]]),
             seurat_pf_macrophages@meta.data,
             expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD1c",],
             Feature = "CD1C",
             Modality = "CITE") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD163",],
                                  Feature = "CD163",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD14-M5E2",],
                                  Feature = "CD14",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD192",],
                                  Feature = "CD192",
                                  Modality = "CITE")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
                                  seurat_pf_macrophages@meta.data,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD115",],
                                  Feature = "CD115",
                                  Modality = "CITE")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD1C", "CD163", "CD14", "CD192", "CD115")),
                  celltype = factor(manual_l4, levels = celltype_order_pf_macrophages_l4$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_macrophages_l4$number_subset)) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% 
        dplyr::arrange(expr) %>%
        ggplot(aes(x = gexUMAP_1, y = gexUMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        #scale_color_viridis() +
        scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              # axis.text.x = element_blank(),
              # axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              # axis.text.y = element_blank(),
              # axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_macrophages_colmyeloidcitemarkers_ggplotobj_list, nrow = 1, ncol = 5))

pdf("umap_hc_pf_macrophages_colmyeloidcitemarkers_colrd.pdf", width = 15, height = 3)
print(ggarrange(plotlist = umap_hc_pf_macrophages_colmyeloidcitemarkers_ggplotobj_list, nrow = 1, ncol = 5))
dev.off()
```

### Violinplots HC PF Macrophages facetted by macrophage CITE markers

```{r violinplot hc pf macrophages fac_macrophagecitemarkers, fig.width=3, fig.height=15}
violinplot_hc_pf_macrophages_macrophagescitemarker_ggplotobj <- 
  data.frame(CB = colnames(seurat_pf_macrophages),
             seurat_pf_macrophages@meta.data,
             expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD163",],
             Feature = "CD163",
             Modality = "CITE") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.HLA.DR",],
                                Feature = "HLA-DR",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD115",],
                                Feature = "CD115",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD169",],
                                Feature = "CD169",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD64",],
                                Feature = "CD64",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD86",],
                                Feature = "CD86",
                                Modality = "CITE")) %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                seurat_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_pf_macrophages, assay = "CITE")["Hu.CD279",],
                                Feature = "CD279",
                                Modality = "CITE")) %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                Feature = factor(Feature, levels = c("CD163", "HLA-DR", "CD115", "CD169", "CD64", "CD86", "CD279")),
                celltype = factor(manual_l4, levels = celltype_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l4$number_subset)) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  #geom_violin(trim = F, scale = "width") +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~Feature, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_macrophages_macrophagescitemarker_ggplotobj)

pdf("violinplot_hc_pf_macrophages_macrophagescitemarker2.pdf", width = 4, height = 1.5*7)
print(violinplot_hc_pf_macrophages_macrophagescitemarker_ggplotobj)
dev.off()
```

### Violinplots HC PF Myeloid VSIG4

```{r violinplot hc pf fac_mnpmarkers, fig.width=3, fig.height=3}
violinplot_hc_pf_myeloid_vsig4_ggplotobj <- data.frame(CB = colnames(seurat_pf_myeloid),
                                                       Embeddings(seurat_pf_myeloid[["wnn.umap"]]),
                                                       seurat_pf_myeloid@meta.data,
                                                       expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["VSIG4",],
                                                       Feature = "VSIG4",
                                                       Modality = "RNA") %>%
  dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                Feature = factor(Feature, levels = c("VSIG4")),
                celltype = factor(manual_l4, levels = celltype_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l4$number_subset)) %>%
  dplyr::filter(manual_l2 %in% c("Macrophages", "CDCs", "PDCs")) %>%
  ggplot(aes(x = celltype, y = expr, fill = celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~Feature, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_myeloid_vsig4_ggplotobj)

pdf("violinplot_hc_pf_myeloid_vsig4.pdf", width = 4, height = 3)
print(violinplot_hc_pf_myeloid_vsig4_ggplotobj)
dev.off()
```

### UMAP HC PBMC PF colored by tissue

```{r umap hc pbmc pf col_tissue, fig.width=7.5, fig.height=7.5}
umap_hc_pbmc_pf_coltissue_ggplotobj <- data.frame(CB = colnames(seurat_pbmc_pf),
                                                  Embeddings(seurat_pbmc_pf[["umap"]]),
                                                  seurat_pbmc_pf@meta.data) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, col = Tissue, partition = Tissue)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  #geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  geom_point_rast(show.legend = T, size = 0.25) +
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = tissue_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pbmc_pf_coltissue_ggplotobj)

# pdf("umap_hc_pbmc_pf_coltissue.pdf", width = 7.5, height=7.5)
# print(umap_hc_pbmc_pf_coltissue_ggplotobj)
# dev.off()
```

### UMAP HC PBMC PF split and colored by tissue

```{r umap hc pbmc pf col_tissue, fig.width=15, fig.height=7.5}
umap_hc_pbmc_pf_splittissue_coltissue_ggplotobj <- data.frame(CB = colnames(seurat_pbmc_pf),
                                                  Embeddings(seurat_pbmc_pf[["umap"]]),
                                                  seurat_pbmc_pf@meta.data) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, col = Tissue, partition = Tissue)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  #geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  geom_point_rast(show.legend = T, size = 0.25) +
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = tissue_colors) +
  facet_grid(.~Tissue) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pbmc_pf_splittissue_coltissue_ggplotobj)

# pdf("umap_hc_pbmc_pf_splittissue_coltissue.pdf", width = 15, height=7.5)
# print(umap_hc_pbmc_pf_splittissue_coltissue_ggplotobj)
# dev.off()
```

### Boxplot HC PBMC PF l1rl0 colored by tissue

```{r boxplot hc pbmc pf l1rl0 col_tissue, fig.width=4, fig.height=5}
boxplot_hc_pbmc_pf_l1rl0_ggplotobj <- seurat_pbmc_pf@meta.data %>%
  dplyr::group_by(manual_l1, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l1), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l1, -Ncellperc), y = Ncellperc, fill = Tissue)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%CD45+ cells") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pbmc_pf_l1rl0_ggplotobj)

# pdf("boxplot_hc_pbmc_pf_l1rl0.pdf", width = 4, height=4)
# print(boxplot_hc_pbmc_pf_l1rl0_ggplotobj)
# dev.off()

# seurat_pbmc_pf@meta.data %>%
#   dplyr::group_by(manual_l1, SampleID, Tissue, .drop = T) %>% 
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l1), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(SampleID, Tissue) %>%
#   dplyr::mutate(Nlrefsample = sum(Ncells),
#                 Ncellprop = Ncells/Nlrefsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
#   readr::write_csv(file = "hc_pbmc_pf_l1rl0.csv")

```

### Boxplot HC PBMC PF l2rl0 colored by tissue

```{r boxplot hc pbmc pf l2rl0 col_tissue, fig.width=4, fig.height=5}
boxplot_hc_pbmc_pf_l2rl0_ggplotobj <- seurat_pbmc_pf@meta.data %>%
  dplyr::group_by(manual_l2, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l2, -Ncellperc), y = Ncellperc, fill = Tissue)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%CD45+ cells") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pbmc_pf_l2rl0_ggplotobj)

pdf("boxplot_hc_pbmc_pf_l2rl0.pdf", width = 4, height=4)
print(boxplot_hc_pbmc_pf_l2rl0_ggplotobj)
dev.off()

seurat_pbmc_pf@meta.data %>%
  dplyr::group_by(manual_l2, SampleID, Tissue, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  readr::write_csv(file = "hc_pbmc_pf_l2rl0.csv")

```

### Boxplot HC PBMC PF l2l3rl0 colored by tissue

```{r boxplot hc pbmc pf l2l3rl0 col_tissue, fig.width=4, fig.height=5}
boxplot_hc_pbmc_pf_l2l3rl0_ggplotobj <- seurat_pbmc_pf@meta.data %>%
  dplyr::mutate(celltype = manual_l3,
                celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+"), "Mono-macs", celltype),
                celltype = factor(celltype, levels = celltype_order_l2_l3$celltype)) %>%
  dplyr::group_by(celltype, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(celltype), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Tissue = gsub("^pt[0-9]{2}_(.+)$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(celltype, -Ncellperc), y = Ncellperc, fill = Tissue)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%CD45+ cells") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pbmc_pf_l2l3rl0_ggplotobj)

pdf("boxplot_hc_pbmc_pf_l2l3rl0.pdf", width = 10, height=4)
print(boxplot_hc_pbmc_pf_l2l3rl0_ggplotobj)
dev.off()

seurat_pbmc_pf@meta.data %>%
  dplyr::mutate(celltype = manual_l3,
                celltype = ifelse(celltype %in% c("Classical monocytes", "Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+"), "Mono-macs", celltype),
                celltype = factor(celltype, levels = celltype_order_l2_l3$celltype)) %>%
  dplyr::group_by(celltype, SampleID, Tissue, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(celltype), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Tissue = gsub("^pt[0-9]{2}_(.+)$", "\\1", SampleID)) %>%
  readr::write_csv(file = "hc_pbmc_pf_l23rl0.csv")
```

### Boxplot HC PBMC PF l3rl0 colored by tissue

```{r boxplot hc pbmc pf l3rl0 col_tissue, fig.width=4, fig.height=5}
boxplot_hc_pbmc_pf_l3rl0_ggplotobj <- seurat_pbmc_pf@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Tissue = gsub("^pt[0-9]{2}_(.+)$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l3, -Ncellperc), y = Ncellperc, fill = Tissue)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5, position = position_dodge(width = 0.75)) +
  scale_fill_manual(values = tissue_colors) +
  labs(y = "%CD45+ cells") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pbmc_pf_l3rl0_ggplotobj)

pdf("boxplot_hc_pbmc_pf_l3rl0.pdf", width = 10, height=4)
print(boxplot_hc_pbmc_pf_l3rl0_ggplotobj)
dev.off()

seurat_pbmc_pf@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, Tissue, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, Tissue) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Tissue = gsub("^pt[0-9]{2}_(.+)$", "\\1", SampleID)) %>%
  readr::write_csv(file = "hc_pbmc_pf_l3rl0.csv")
```

### Boxplot HC PF l2rl0 colored by l2 split by l1

```{r boxplot hc pf l2rl0 col_l2, fig.width=7.5, fig.height=5}
hc_pf_l2rl0_proportions_df <- seurat_pbmc_pf@meta.data %>%
  dplyr::filter(Tissue == "PF") %>%
  dplyr::group_by(manual_l2, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_pbmc_pf@meta.data[,c("manual_l1", "manual_l2")]), by = "manual_l2") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(pfvpbmc_dacs_l2rl0[[1]]$da, by = c("manual_l2" = "BaselineProp.clusters"))

boxplot_hc_pf_l2rl0_splitl1_ggplotobj <- ggarrange(plotlist = lapply(split(hc_pf_l2rl0_proportions_df, factor(hc_pf_l2rl0_proportions_df$manual_l1, levels = c("T", "NK/ILC", "B", "Myeloid"))), function(manual_l1){
  manual_l1 %>%
    ggplot(aes(x = forcats::fct_reorder(manual_l2, -Ncellperc), y = Ncellperc, fill = manual_l2)) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(position = position_dodge(width=0.75)) +
    facet_wrap(.~ manual_l1) +
    labs(y = "%CD45+ cells") +
    theme_bw() +
    scale_color_manual(values = manual_l2_colors_pf) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "bottom",
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}), widths = c(10, 4, 4, 7.5), nrow = 1, align = "hv", legend = "bottom", common.legend = T)

print(boxplot_hc_pf_l2rl0_splitl1_ggplotobj)

# pdf("boxplot_hc_pf_l2rl0_splitl1.pdf", width = 8, height = 5)
# print(boxplot_hc_pf_l2rl0_splitl1_ggplotobj)
# dev.off()


boxplot_hc_pf_l2rl0_ggplotobj <- seurat_pf@meta.data %>%
  dplyr::group_by(manual_l2, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l2, -Ncellperc), y = Ncellperc, fill = manual_l2)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA) +
  geom_point_rast(size = 1.5) +
  scale_fill_manual(values = manual_l2_colors) +
  labs(y = "%CD45+ cells") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pf_l2rl0_ggplotobj)

# pdf("boxplot_hc_pf_l2rl0.pdf", width = 7.5, height=5)
# print(boxplot_hc_pf_l2rl0_ggplotobj)
# dev.off()

seurat_pbmc_pf@meta.data %>%
  dplyr::filter(Tissue == "PF") %>%
  dplyr::group_by(manual_l2, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_pbmc_pf@meta.data[,c("manual_l1", "manual_l2")]), by = "manual_l2") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  readr::write_csv(file = "hc_pf_l2rl0.csv")
```

### Boxplot HC PF l3rl0 colored by l3 split by l1

```{r boxplot hc pf l3rl0 col_l3 split_l1, fig.width=9, fig.height=5}
hc_pf_l3rl0_proportions_df <- seurat_pbmc_pf@meta.data %>%
  dplyr::filter(Tissue == "PF") %>%
  dplyr::group_by(manual_l3, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_pbmc_pf@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(pfvpbmc_dacs_l3rl0[[1]]$da, by = c("manual_l3" = "BaselineProp.clusters"))

boxplot_hc_pf_l3rl0_splitl1_ggplotobj <- ggarrange(plotlist = lapply(split(hc_pf_l3rl0_proportions_df, factor(hc_pf_l3rl0_proportions_df$manual_l1, levels = c("T", "NK/ILC", "B", "Myeloid"))), function(manual_l1){
  manual_l1 %>%
    ggplot(aes(x = forcats::fct_reorder(manual_l3, -Ncellperc), y = Ncellperc, fill = manual_l3)) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(position = position_dodge(width=0.75)) +
    facet_wrap(.~ manual_l1) +
    labs(y = "%CD45+ cells") +
    theme_bw() +
    scale_color_manual(values = manual_l3_colors_pf) +
    theme(panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "bottom",
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
}), widths = c(10, 4, 4, 7.5), nrow = 1, align = "hv", legend = "bottom", common.legend = T)

print(boxplot_hc_pf_l3rl0_splitl1_ggplotobj)

# pdf("boxplot_hc_pf_l3rl0_splitl1.pdf", width = 8, height = 5)
# print(boxplot_hc_pf_l3rl0_splitl1_ggplotobj)
# dev.off()

seurat_pbmc_pf@meta.data %>%
  dplyr::filter(Tissue == "PF") %>%
  dplyr::group_by(manual_l3, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_pbmc_pf@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  readr::write_csv(file = "hc_pf_l3rl0.csv")
```

```{r hc pf l4rl0 data}
seurat_pf@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  readr::write_delim("hc_pf_l4rl0.csv")
```

```{r hc pf mnp l4rl1 data}
seurat_pf_myeloid@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  readr::write_delim("hc_pf_mnp_l4rl1.csv")
```

### UMAP HC PF Macrophages colored by l4 labeled by l4

```{r umap hc pf col_l4 lab_l4, fig.width=7.5, fig.height=7.5}
umap_hc_pf_macrophages_coll4_labl4_ggplotobj <- data.frame(
  CB = colnames(seurat_pf_macrophages),
  Embeddings(seurat_pf_macrophages[["gex.umap"]]),
  seurat_pf_macrophages@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_macrophages_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_macrophages_l4$number_subset)) %>% 
  ggplot(aes(x = gexUMAP_1, y = gexUMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 2.5, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = gexUMAP_1),
                               y = median(x = gexUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size = 8,
                   show.legend = F, 
                   label.size = 0.25) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_number_colors_pf_macrophages) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_pf_macrophages_coll4_labl4_ggplotobj)

pdf("umap_hc_pf_macrophages_coll4_labl4_p2.5_5x5_s8_ls025.pdf", width = 5, height = 5)
print(umap_hc_pf_macrophages_coll4_labl4_ggplotobj)
dev.off()
```

### Boxplot HC PF macrophages entropy

```{r boxplot hc pf macrophages entropy col_l3, fig.width=5, fig.height=5}
boxplot_hc_pf_macrophages_entropy_ggplotobj <- colData(hc_pf_macrophages_trajectory_sce) %>%
  data.frame() %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l4, -entropy), y = entropy, fill = manual_l4)) +
  geom_point_rast(position = position_jitterdodge(), alpha = 0.3, size = 0.05) +
  geom_boxplot(outlier.shape = NA) +
  labs(y = "Entropy") +
  theme_bw() +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pdf("boxplot_hc_pf_macrophages_entropy.pdf", width = 3, height=4)
print(boxplot_hc_pf_macrophages_entropy_ggplotobj)
dev.off()
```

```{r hc pf entropy differential}
hc_pf_macrophages_trajectory_coldata <- colData(hc_pf_macrophages_trajectory_sce) %>%
  data.frame() %>%
  dplyr::filter(manual_l2 != "Monocytes") %>%
  dplyr::mutate(Donor = as.factor(Donor),
                Tissue = as.factor(Tissue))

lmer_full <- lmer(entropy~manual_l4+(1|Donor), data = hc_pf_macrophages_trajectory_coldata)
lmer_red <- lmer(entropy~(1|Donor), data = hc_pf_macrophages_trajectory_coldata)
lrt_results <- anova(lmer_full, lmer_red)

hc_pf_macrophages_trajectory_coldata_lme <- lme(entropy ~ manual_l4, random=~1|Donor, data=hc_pf_macrophages_trajectory_coldata)
bla <- emmeans(hc_pf_macrophages_trajectory_coldata_lme, pairwise ~ manual_l4)
```

### Scatterplot HC PF Macrophages VCAN+ entropy vs CD14 expression

```{r boxplot hc pf macrophages entropy col_l3, fig.width=4, fig.height=3}
scatterplot_hc_pf_macrophages_vcan_entropy_v_cd14_ggplotobj <- colData(hc_pf_macrophages_trajectory_sce) %>%
  data.frame() %>%
  dplyr::mutate(CD14 = assay(hc_pf_macrophages_trajectory_sce, "logcounts")["CD14",]) %>%
  dplyr::filter(manual_l4 == "Macrophages VCAN+") %>%
  ggplot(aes(x = CD14, y = entropy)) +
  geom_point_rast() +
  labs(y = "Entropy",
       x = "CD14 expression") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom")

print(scatterplot_hc_pf_macrophages_vcan_entropy_v_cd14_ggplotobj)
```

### UMAP HC PF macrophages colored by entropy

```{r umap hc pf macrophages col_entropy trajectory, fig.width=7.5, fig.height=7.5}
umap_hc_pf_macrophages_l4_colentropy_ggplotobj <- data.frame(
  CB = colnames(hc_pf_macrophages_trajectory_sce),
  reducedDim(hc_pf_macrophages_trajectory_sce , "WNN.UMAP"),
  colData(hc_pf_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_pf_macrophages_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_macrophages_l4$number_subset)) %>% 
  ggplot(aes(x = wnnUMAP_1, y = wnnUMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = entropy)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = wnnUMAP_1),
                               y = median(x = wnnUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 0.75,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_manual(values = manual_l4_monocytes_macrophages_number_colors) +
  scale_color_viridis() +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_hc_pf_macrophages_l4_colentropy.pdf", width = 5, height=5.5)
print(umap_hc_pf_macrophages_l4_colentropy_ggplotobj)
dev.off()
```

### UMAP HC PF macrophages colored by pseudotime (rooted at Macrophages VCAN+)

```{r umap hc pf macrophages col_pseudotime trajectory, fig.width=7.5, fig.height=7.5}
colData(hc_pf_macrophages_trajectory_sce)$Pseudotime <- averagePseudotime(hc_pf_macrophages_trajectory_tscan_rootmacrophagesvcan) 

umap_hc_pf_macrophages_l4_colpseudotime_ggplotobj <- data.frame(
  CB = colnames(hc_pf_macrophages_trajectory_sce),
  reducedDim(hc_pf_macrophages_trajectory_sce , "GEX.UMAP"),
  colData(hc_pf_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_pf_macrophages_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_macrophages_l4$number_subset)) %>% 
  dplyr::arrange(Pseudotime) %>%
  ggplot(aes(x = gexUMAP_1, y = gexUMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Pseudotime)) +
  geom_line(data = hc_pf_macrophages_trajectory_aggregated_lines, mapping=aes(x=gexUMAP_1, y=gexUMAP_2, group=edge), linewidth = 2) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = gexUMAP_1),
                               y = median(x = gexUMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   # alpha = 0.75,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_viridis() +
  scale_colour_gradient(low = "#C7E9C0", high = "#005A32") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_hc_pf_macrophages_l4_colpseudotime.pdf", width = 5, height=5.5)
print(umap_hc_pf_macrophages_l4_colpseudotime_ggplotobj)
dev.off()
```

### Heatmap PEX HC PF myeloid colored by l4

```{r heatmap pex hc pf myeloid col_cellmarkers, fig.width=5, fig.height=6.5}
myeloid_markers_pex <- GetAssayData(seurat_pf_myeloid, assay = "CITE")[which(rownames(GetAssayData(seurat_pf_myeloid, assay = "CITE")) %in% pf_myeloid_markers$FeatureID), ]

seurat_pf_myeloid@meta.data$manual_l4 <- factor(seurat_pf_myeloid@meta.data$manual_l4, levels = celltype_order_pf_myeloid_l4$celltype)

Idents(seurat_pf_myeloid) <- "manual_l4"
seurat_pf_myeloid_avexprl4 <- AverageExpression(seurat_pf_myeloid, return.seurat = T)

marker_pf_myeloid_avepexprl4_pex <- GetAssayData(seurat_pf_myeloid_avexprl4, assay = "CITE")[pf_myeloid_markers$FeatureID, ]

heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(
  marker_pf_myeloid_avepexprl4_pex, 
  color = PurpleAndYellow(1000),
  labels_row = pf_myeloid_markers$protein,
  cluster_rows = F, 
  cluster_cols = F, 
  scale = "row",
  name = "Scaled median")

print(heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj)

pdf("heatmap_hc_pf_myeloid_myeloidmarkers_pex.pdf", width = 4.5, height = 6)
print(heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj)
dev.off()
```

### Dotplot GEX HC PF myeloid colored by l4

```{r dotplot gex hc pf col_cellmarkers, fig.width = 3.5, fig.height=6.5}
myeloid_markers_gex <- GetAssayData(seurat_pf_myeloid, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_myeloid, assay = "RNA")) %in% pf_myeloid_markers$gene), ]

dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(myeloid_markers_gex), myeloid_markers_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_myeloid@meta.data), 
                               Celltype = seurat_pf_myeloid@meta.data[,"manual_l4"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l4_order),
                FeatureID = factor(FeatureID, pf_myeloid_markers$gene)) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj)

# pdf("dotplot_hc_pf_myeloid_myeloidmarkers_gex.pdf", width = 3, height=6)
# print(dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj)
# dev.off()
```

### Heatmap PEX HC PF myeloid unsupervised markers colored by l4

#### HOTFIX START
```{r myeloid markers unsupervised}
Idents(seurat_pf_myeloid) <- "manual_l4"
myeloid_cite_findmarkers <- FindAllMarkers(seurat_pf_myeloid, assay = "CITE", only.pos = T)
myeloid_cite_findmarkers <- split(myeloid_cite_findmarkers, myeloid_findmarkers$cluster)
```
#### HOTFIX END

```{r heatmap pex hc pf myeloid supervised col_cellmarkers, fig.width=5, fig.height=6.5}
#myeloid_markers_unsupervised <- unique(unlist(lapply(myeloid_findmarkers, function(i){i[1:3,"gene"]})))
myeloid_markers_unsupervised <- unique(unlist(lapply(myeloid_cite_findmarkers, function(i){i[1:5,"gene"]})))
myeloid_markers_unsupervised <- myeloid_markers_unsupervised[!is.na(myeloid_markers_unsupervised)]

myeloid_markers_pex <- GetAssayData(seurat_pf_myeloid, assay = "CITE")[which(rownames(GetAssayData(seurat_pf_myeloid, assay = "CITE")) %in% pf_myeloid_unsupervised_markers$protein), ]

seurat_pf_myeloid@meta.data$manual_l4 <- factor(seurat_pf_myeloid@meta.data$manual_l4, levels = celltype_order_pf_myeloid_l4$celltype)

Idents(seurat_pf_myeloid) <- "manual_l4"
seurat_pf_myeloid_avexprl4 <- AverageExpression(seurat_pf_myeloid, return.seurat = T)

marker_pf_myeloid_avepexprl4_pex <- GetAssayData(seurat_pf_myeloid_avexprl4, assay = "CITE")[pf_myeloid_unsupervised_markers$FeatureID, ]

heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(
  marker_pf_myeloid_avepexprl4_pex, 
  color = PurpleAndYellow(1000),
  labels_row = pf_myeloid_unsupervised_markers$protein,
  cluster_rows = F, 
  cluster_cols = F, 
  scale = "row",
  name = "Scaled median")

print(heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj)

pdf("heatmap_hc_pf_myeloid_unsupervisedmyeloidmarkers_pex.pdf", width = 4, height = 7.5)
print(heatmap_hc_pf_myeloid_myeloidmarkers_pex_complexheatmapobj)
dev.off()
```

### Dotplot GEX HC PF myeloid unsupervised markers colored by l4

```{r dotplot gex hc pf col_cellmarkers, fig.width = 3.5, fig.height=6.5}
myeloid_markers_gex <- GetAssayData(seurat_pf_myeloid, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_myeloid, assay = "RNA")) %in% pf_myeloid_unsupervised_markers$gene), ]

dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(myeloid_markers_gex), myeloid_markers_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_myeloid@meta.data), 
                               Celltype = seurat_pf_myeloid@meta.data[,"manual_l4"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l4_order),
                FeatureID = factor(FeatureID, rev(pf_myeloid_unsupervised_markers$gene))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj)

pdf("dotplot_hc_pf_myeloid_unsupervisedmyeloidmarkers_gex.pdf", width = 3, height=7.5)
print(dotplot_hc_pf_myeloid_myeloidmarkers_gex_ggplotobj)
dev.off()
```

### Heatmap PEX HC PF macrophages unsupervised markers colored by l4

#### HOTFIX START

```{r macrophages gex markers unsupervised}
Idents(seurat_pf_macrophages) <- "manual_l4"
macrophages_gex_findmarkers <- FindAllMarkers(seurat_pf_macrophages, assay = "RNA", only.pos = T)
macrophages_gex_findmarkers$cluster <- factor(macrophages_gex_findmarkers$cluster, levels = c("Macrophages VCAN+", "Macrophages C1Q+", "Macrophages VCAN+C1Q+", "Macrophages SPP1+"))
macrophages_gex_findmarkers <- split(macrophages_gex_findmarkers, macrophages_gex_findmarkers$cluster)

macrophages_gex_markers_unsupervised <- unique(unlist(lapply(macrophages_gex_findmarkers, function(i){i[1:5,"gene"]})))
macrophages_gex_markers_unsupervised <- macrophages_gex_markers_unsupervised[!is.na(macrophages_gex_markers_unsupervised)]
```

```{r macrophages cite markers unsupervised}
seurat_pf_macrophages <- NormalizeData(seurat_pf_macrophages, assay = "CITE", normalization.method = "CLR")

Idents(seurat_pf_macrophages) <- "manual_l4"
macrophages_cite_findmarkers <- FindAllMarkers(seurat_pf_macrophages, assay = "CITE", only.pos = T)
macrophages_cite_findmarkers$cluster <- factor(macrophages_cite_findmarkers$cluster, levels = c("Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages C1Q+", "Macrophages SPP1+"))
macrophages_cite_findmarkers <- split(macrophages_cite_findmarkers, macrophages_cite_findmarkers$cluster)

# macrophages_cite_markers_unsupervised <- unique(unlist(lapply(macrophages_cite_findmarkers, function(i){i[1:3,"gene"]})))
macrophages_cite_markers_unsupervised <- unique(unlist(lapply(macrophages_cite_findmarkers, function(i){i[1:5,"gene"]})))
# macrophages_cite_markers_unsupervised <- unique(unlist(lapply(macrophages_cite_findmarkers, function(i){i[1:10,"gene"]})))
macrophages_cite_markers_unsupervised <- macrophages_cite_markers_unsupervised[!is.na(macrophages_cite_markers_unsupervised)]

```

#### HOTFIX END

```{r heatmap pex hc pf macrophages supervised col_cellmarkers, fig.width=3, fig.height=4.5}
seurat_pf_macrophages@meta.data$manual_l4 <- factor(seurat_pf_macrophages@meta.data$manual_l4, levels = c("Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages C1Q+","Macrophages SPP1+"))

Idents(seurat_pf_macrophages) <- "manual_l4"
seurat_pf_macrophages_avexprl4 <- AverageExpression(seurat_pf_macrophages, return.seurat = T)

#marker_pf_macrophages_avepexprl4_pex <- GetAssayData(seurat_pf_macrophages_avexprl4, assay = "CITE")[pf_macrophages_unsupervised_markers$FeatureID, c("Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+")]
marker_pf_macrophages_avepexprl4_pex <- GetAssayData(seurat_pf_macrophages_avexprl4, assay = "CITE")[macrophages_cite_markers_unsupervised, c("Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages C1Q+", "Macrophages SPP1+")] 

heatmap_hc_pf_macrophages_macrophagesmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(
  marker_pf_macrophages_avepexprl4_pex, 
  color = PurpleAndYellow(1000),
  labels_row = gsub("Hu\\.", "", macrophages_cite_markers_unsupervised),
  cluster_rows = F, 
  cluster_cols = F, 
  scale = "row",
  name = "Scaled median")

print(heatmap_hc_pf_macrophages_macrophagesmarkers_pex_complexheatmapobj)

# pdf("heatmap_hc_pf_macrophages_unsupervisedmacrophagemarkers_pex.pdf", width = 2.6, height = 4.5)
 pdf("heatmap_hc_pf_macrophages_unsupervisedmacrophagemarkers_top5_pex.pdf", width = 2.6, height = 6)
#pdf("heatmap_hc_pf_macrophages_unsupervisedmacrophagemarkers_top10_pex.pdf", width = 3, height = 10)
print(heatmap_hc_pf_macrophages_macrophagesmarkers_pex_complexheatmapobj)
dev.off()
```

```{r violinplot hc pf macrophages unsupervisedmacrophagemarker, fig.width=4, fig.height=8}
hc_pf_macrophage_unsupervisedmacrophagemarker_pex_norm <- GetAssayData(seurat_pf_macrophages, assay = "CITE")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "CITE", slot = "data")) %in% macrophages_cite_markers_unsupervised), ]

macrophages_cite_markers_unsupervised_renamed <- gsub("Hu(|Ms)\\.", "", macrophages_cite_markers_unsupervised)

violinplot_hc_pf_macrophage_unsupervisedmacrophagemarker_pex_ggplotobj <- data.frame(
  CB = colnames(hc_pf_macrophage_unsupervisedmacrophagemarker_pex_norm), 
  t(hc_pf_macrophage_unsupervisedmacrophagemarker_pex_norm)) %>%
  tidyr::pivot_longer(-c(CB), names_to = "FeatureID", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_macrophages@meta.data), 
                               Celltype = seurat_pf_macrophages@meta.data[,"manual_l4"],
                               Study = seurat_pf_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype, levels = names(manual_l4_colors_pf)), 
                FeatureID = gsub("Hu(|Ms)\\.", "", FeatureID),
                FeatureID = factor(FeatureID, levels = macrophages_cite_markers_unsupervised_renamed)) %>%
  ggplot(aes(x = Celltype, y = nUMIs, fill = Celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~FeatureID, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_macrophage_unsupervisedmacrophagemarker_pex_ggplotobj)

pdf("violinplot_hc_pf_macrophage_unsupervisedmacrophagemarker_top5_pex.pdf", width = 2, height = 10)
# pdf("violinplot_hc_pf_macrophage_unsupervisedmacrophagemarker_top10_pex.pdf", width = 2, height = 20)
print(violinplot_hc_pf_macrophage_unsupervisedmacrophagemarker_pex_ggplotobj)
dev.off()
```

### Dotplot GEX HC PF macrophages unsupervised markers colored by l4

```{r dotplot gex hc pf macrophages col_cellmarkers, fig.width = 1.75, fig.height=5}
macrophages_gex_markers_unsupervised <- unique(unlist(lapply(macrophages_gex_findmarkers, function(i){i[1:10,"gene"]})))
macrophages_gex_markers_unsupervised <- macrophages_gex_markers_unsupervised[!is.na(macrophages_gex_markers_unsupervised)]

#macrophages_markers_gex <- GetAssayData(seurat_pf_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "RNA")) %in% pf_macrophages_unsupervised_markers$gene), ]
macrophages_markers_gex <- GetAssayData(seurat_pf_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "RNA")) %in% macrophages_gex_markers_unsupervised), ]

dotplot_hc_pf_macrophages_macrophagesmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(macrophages_markers_gex), macrophages_markers_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_macrophages@meta.data), 
                               Celltype = seurat_pf_macrophages@meta.data[,"manual_l4"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, manual_l4_order),
                #FeatureID = factor(FeatureID, rev(pf_macrophages_unsupervised_markers$gene))) %>% 
                FeatureID = factor(FeatureID, macrophages_gex_markers_unsupervised)) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_macrophages_macrophagesmarkers_gex_ggplotobj)

# pdf("dotplot_hc_pf_macrophages_unsupervisedmacrophagesmarkers_gex.pdf", width = 1.8, height=5)
# pdf("dotplot_hc_pf_macrophages_unsupervisedmacrophagesmarkers_top5_gex.pdf", width = 1.8, height=7)
pdf("dotplot_hc_pf_macrophages_unsupervisedmacrophagesmarkers_top10_gex.pdf", width = 1.8, height=14)
print(dotplot_hc_pf_macrophages_macrophagesmarkers_gex_ggplotobj)
dev.off()
```

### Violinplot PEX HC PF macrophages PEX m2markers colored by l4

```{r violinplot hc pf macrophages pex m2marker, fig.width=4, fig.height=8}
m2markers_pex <- c("Hu.CD304", "Hu.CD112", "Hu.CD28", "Hu.CD39", "Hu.CD72", "Hu.CD169")

hc_pf_macrophage_m2marker_pex_norm <- GetAssayData(seurat_pf_macrophages, assay = "CITE")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "CITE", slot = "data")) %in% m2markers_pex), ]

m2markers_pex_renamed <- gsub("Hu(|Ms)\\.", "", m2markers_pex)

violinplot_hc_pf_macrophage_m2marker_pex_ggplotobj <- data.frame(
  CB = colnames(hc_pf_macrophage_m2marker_pex_norm), 
  t(hc_pf_macrophage_m2marker_pex_norm)) %>%
  tidyr::pivot_longer(-c(CB), names_to = "FeatureID", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_macrophages@meta.data), 
                               Celltype = seurat_pf_macrophages@meta.data[,"manual_l4"],
                               Study = seurat_pf_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype, levels = names(manual_l4_colors_pf)), 
                FeatureID = gsub("Hu(|Ms)\\.", "", FeatureID),
                FeatureID = factor(FeatureID, levels = m2markers_pex_renamed)) %>%
  ggplot(aes(x = Celltype, y = nUMIs, fill = Celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~FeatureID, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_macrophage_m2marker_pex_ggplotobj)

pdf("violinplot_hc_pf_macrophage_m2marker_pex.pdf", width = 2, height = 5)
print(violinplot_hc_pf_macrophage_m2marker_pex_ggplotobj)
dev.off()
```

### Violinplot GEX HC PF macrophages GEX m2markers colored by l4

```{r violinplot hc pf macrophages gex m2marker, fig.width=4, fig.height=8}
m2markers_gex <- c("NRP1", "NECTIN2", "CD28", "ENTPD1", "CD72", "SIGLEC1")

hc_pf_macrophage_m2marker_gex_norm <- GetAssayData(seurat_pf_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "RNA", slot = "data")) %in% m2markers_gex), ]

violinplot_hc_pf_macrophage_m2marker_gex_ggplotobj <- data.frame(
  CB = colnames(hc_pf_macrophage_m2marker_gex_norm), 
  t(hc_pf_macrophage_m2marker_gex_norm)) %>%
  tidyr::pivot_longer(-c(CB), names_to = "FeatureID", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_macrophages@meta.data), 
                               Celltype = seurat_pf_macrophages@meta.data[,"manual_l4"],
                               Study = seurat_pf_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype, levels = names(manual_l4_colors_pf)), 
                FeatureID = gsub("Hu(|Ms)\\.", "", FeatureID),
                FeatureID = factor(FeatureID, levels = m2markers_gex)) %>%
  ggplot(aes(x = Celltype, y = nUMIs, fill = Celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~FeatureID, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_macrophage_m2marker_gex_ggplotobj)

pdf("violinplot_hc_pf_macrophage_m2marker_gex.pdf", width = 2, height = 5)
print(violinplot_hc_pf_macrophage_m2marker_gex_ggplotobj)
dev.off()
```

### Dotplot GEX HC PF macrophages M1/M2 markers colored by l4

```{r dotplot gex hc pf col_cellmarkers, fig.width = 1.75, fig.height=5}
m1m2marker_gex <- c("IL1B", "IL6", "S100A8", "IDO1", "APOE", "CD163", "FOLR2", "MRC1", "TREM2", "MERTK")

macrophages_m1m2markers_gex <- GetAssayData(seurat_pf_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "RNA")) %in% m1m2marker_gex), ]

dotplot_hc_pf_macrophages_m1m2markers_gex_ggplotobj <- data.frame(FeatureID = rownames(macrophages_m1m2markers_gex), macrophages_m1m2markers_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_macrophages@meta.data), 
                               Celltype = seurat_pf_macrophages@meta.data[,"manual_l4"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                #Celltype = factor(Celltype, manual_l4_order),
                Celltype = factor(Celltype, c("Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages C1Q+", "Macrophages SPP1+")),
                FeatureID = factor(FeatureID, rev(m1m2marker_gex[which(m1m2marker_gex %in% FeatureID)]))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  scale_color_viridis() +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_macrophages_m1m2markers_gex_ggplotobj)

pdf("dotplot_hc_pf_macrophages_m1m2markers_gex.pdf", width = 1.8, height=5)
print(dotplot_hc_pf_macrophages_m1m2markers_gex_ggplotobj)
dev.off()
```

### Heatmap GEX HC PF macrophages M1/M2 markers colored by l4

```{r heatmap gex hc pf macrophages m1m2markers col_cellmarkers, fig.width=3, fig.height=4.5}
m1m2marker_gex <- c("IL1B", "IL6", "S100A8", "IDO1", "APOE", "CD163", "FOLR2", "MRC1", "TREM2", "MERTK")

seurat_pf_macrophages@meta.data$manual_l4 <- factor(seurat_pf_macrophages@meta.data$manual_l4, levels = c("Macrophages C1Q+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages SPP1+"))

Idents(seurat_pf_macrophages) <- "manual_l4"
seurat_pf_macrophages_avexprl4 <- AverageExpression(seurat_pf_macrophages, return.seurat = T)

marker_pf_macrophages_avepexprl4_m1m2markers_gex <- GetAssayData(seurat_pf_macrophages_avexprl4, assay = "CITE")[which(rownames(seurat_pf_macrophages_avexprl4) %in% m1m2markers_gex), c("Macrophages C1Q+", "Macrophages SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+")]

marker_pf_macrophages_avepexprl4_m1m2markers_gex_complexheatmapobj <- ComplexHeatmap::pheatmap(
  marker_pf_macrophages_avepexprl4_m1m2markers_gex, 
  color = PurpleAndYellow(1000),
  labels_row = gsub("Hu\\.", "", pf_macrophages_unsupervised_markers$protein),
  cluster_rows = F, 
  cluster_cols = F, 
  scale = "row",
  name = "Scaled median")

print(heatmap_hc_pf_macrophages_macrophagesmarkers_pex_complexheatmapobj)

pdf("heatmap_hc_pf_macrophages_unsupervisedmacrophagemarkers_pex.pdf", width = 2.6, height = 4.5)
print(heatmap_hc_pf_macrophages_macrophagesmarkers_pex_complexheatmapobj)
dev.off()
```

```{r violinplot hc pf macrophages m1m2marker, fig.width=4, fig.height=8}
hc_pf_macrophage_m1m2marker_gex_norm <- GetAssayData(seurat_pf_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_macrophages, assay = "RNA", slot = "data")) %in% m1m2marker_gex), ]

hc_pf_macrophage_m1m2marker_gex_norm <- FetchData(seurat_pf_macrophages, vars = m1m2marker_gex)

violinplot_hc_pf_macrophage_m1m2marker_gex_ggplotobj <- data.frame(
  FeatureID = colnames(hc_pf_macrophage_m1m2marker_gex_norm), 
  t(hc_pf_macrophage_m1m2marker_gex_norm)) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_liver_colon_macrophages@meta.data), 
                               Celltype = seurat_pf_liver_colon_macrophages@meta.data[,"manual_l4"],
                               Study = seurat_pf_liver_colon_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype, levels = names(manual_l4_colors_pf)), 
                FeatureID = factor(FeatureID, levels = m1m2marker_gex[which(m1m2marker_gex %in% FeatureID)])) %>%
  ggplot(aes(x = Celltype, y = nUMIs, fill = Celltype)) +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~FeatureID, ncol = 1, scales = "free_y", strip.position = "right") +
  labs(y = "nUMIs") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_fill_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "none",
        # axis.text.x = element_blank(),
        # axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(face = "bold"),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.spacing = unit(0, "lines"))

print(violinplot_hc_pf_macrophage_m1m2marker_gex_ggplotobj)

pdf("violinplot_hc_pf_macrophage_m1m2marker_gex.pdf", width = 2, height = 8)
print(violinplot_hc_pf_macrophage_m1m2marker_gex_ggplotobj)
dev.off()
```

### Jitteredboxplot HC PF Macrophages TAM classification

```{r jitteredboxplot hc pf macrophages tam classification, fig.width = 15, fig.height = 3.5}
jitteredboxplot_hc_pf_macrophages_tamclassification_ggplotobj <- pf_macrophages_tamannotation_scores %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell Score") %>%
  ggplot(aes(x = TAM, y = `UCell Score`, col = manual_l4)) +
  geom_jitter_rast() +  
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~manual_l4, nrow = 1) +
  scale_color_manual(values = manual_l4_colors_pf) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(jitteredboxplot_hc_pf_macrophages_tamclassification_ggplotobj)

pdf("jitteredboxplot_hc_pf_macrophages_tamclassification.pdf", width = 15, height=3.5)
print(jitteredboxplot_hc_pf_macrophages_tamclassification_ggplotobj)
dev.off()
```

### Radarplot HC PF Macrophages median TAM classification

```{r radarplot hc pf macrophages median tam classification, fig.width = 6, fig.height = 5}
radarplot_hc_pf_macrophages_mediantamclassification_ggplotobj <- pf_macrophages_tamannotation_scores %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell") %>%
  dplyr::group_by(manual_l4, TAM) %>%
  dplyr::summarize(median_UCell = median(UCell)) %>%
  dplyr::mutate(TAM = factor(TAM, levels = c("Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM"))) %>%
  ggplot(aes(x = TAM, y = median_UCell, col = manual_l4, group = manual_l4)) +
  geom_point() +
  geom_encircle(expand = 0, s_shape=1, size = 2) +
  #geom_polygon(fill=NA, stat = "identity", linewidth = 1.3) +  
  #geom_path() +
  scale_color_manual(values = manual_l4_colors_pf) +
  labs(y = "Median UCell Score") +
  coord_polar() +
  theme_bw() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())

pdf("radarplot_hc_pf_macrophages_mediantamclassification.pdf", width = 6, height=5)
print(radarplot_hc_pf_macrophages_mediantamclassification_ggplotobj)
dev.off()
```

```{r heatmap hc pf macrophages average tam genes v1}
macrophage_marker_list <- readRDS(pf_macrophages_marker_list_rds)
tam_markers <- readxl::read_excel(tam_markers_xlsx)

macrophage_marker_sig_list <- lapply(macrophage_marker_list, function(macrophage_marker){
  macrophage_marker %>% 
    dplyr::filter(gene %in% unique(tam_markers$Gene),
                  p_val_adj<0.05)
})

seurat_pf_macrophages@meta.data$manual_l4 <- factor(seurat_pf_macrophages@meta.data$manual_l4, levels = celltype_order_pf_myeloid_l4$celltype)

Idents(seurat_pf) <- "manual_l4"
seurat_pf_macrophages_avexprl4 <- AverageExpression(seurat_pf_macrophages, return.seurat = T)

macophage_marker_avepexprl4 <- GetAssayData(seurat_pf_macrophages_avexprl4, assay = "RNA")[marker_proteins$FeatureID, ]

heatmap_hc_pf_cellmarkers_pex_complexheatmapobj <- ComplexHeatmap::pheatmap(marker_avepexprl3_pex, 
                                                                            color = PurpleAndYellow(1000),
                                                                            labels_row = marker_proteins$protein,
                                                                            cluster_rows = F, 
                                                                            cluster_cols = F, 
                                                                            scale = "row",
                                                                            name = "Scaled median")

print(heatmap_hc_pf_cellmarkers_pex_complexheatmapobj)
```

```{r heatmap hc pf macrophages average tam genes v2, fig.width = 3.5, fig.height =30}
macrophage_marker_list <- readRDS(pf_macrophages_marker_list_rds)
tam_markers <- readxl::read_excel(tam_markers_xlsx)

pf_macrophages_tamannotation_ranks <- pf_macrophages_tamannotation_ranks[which(rowSums(pf_macrophages_tamannotation_ranks) != 0),]

tam_markers_present <- tam_markers[which(tam_markers$Gene %in% rownames(pf_macrophages_tamannotation_ranks)),]

# macrophage_marker_sig_list <- lapply(macrophage_marker_list, function(macrophage_marker){
#   macrophage_marker %>% 
#     dplyr::filter(gene %in% unique(tam_markers$Gene),
#                   p_val_adj<0.05)
# })

# macrophage_marker_sig_genes <- unique(do.call(rbind, macrophage_marker_sig_list)$gene)

pf_macrophages_tamannotation_meanranks_l4 <- pf_macrophages_tamannotation_ranks[tam_markers_present$Gene,] %>%
  data.frame(., gene = rownames(.), TAM = tam_markers_present$TAM) %>%
  tidyr::pivot_longer(-c(gene, TAM), names_to = "CB", values_to = "ranks") %>%
  dplyr::mutate(CB = gsub("\\.", "-", CB)) %>%
  dplyr::left_join(seurat_pf_macrophages@meta.data, by = c("CB" = "cellID")) %>%
  dplyr::group_by(gene, TAM, manual_l4) %>%
  dplyr::summarize(log10_mean_rank = log10(mean(ranks))) %>%
  tidyr::pivot_wider(names_from = "manual_l4", values_from = "log10_mean_rank")

pf_macrophages_tamannotation_meanranks_l4_rank <- data.frame(pf_macrophages_tamannotation_meanranks_l4[,-c(1,2)], row.names = paste0(pf_macrophages_tamannotation_meanranks_l4$gene, "_", pf_macrophages_tamannotation_meanranks_l4$TAM))
colnames(pf_macrophages_tamannotation_meanranks_l4_rank) <- c("Macrophages C1Q+", "Macrophages C1Q+SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages VCAN+SPP1+")
# pf_macrophages_tamannotation_meanranks_l4_rank_z <- data.frame(t(scale(t(pf_macrophages_tamannotation_meanranks_l4_rank), center = T, scale = T)))
pf_macrophages_tamannotation_meanranks_l4_rank_z <- t(data.frame(t(scale(pf_macrophages_tamannotation_meanranks_l4_rank, center = T, scale = T))))

pf_macrophages_tamannotation_meanranks_l4_rank_z <- pf_macrophages_tamannotation_meanranks_l4_rank_z[which(!is.na(rowSums(pf_macrophages_tamannotation_meanranks_l4_rank_z))),]
colnames(pf_macrophages_tamannotation_meanranks_l4_rank_z) <- c("Macrophages C1Q+", "Macrophages C1Q+SPP1+", "Macrophages VCAN+", "Macrophages VCAN+C1Q+", "Macrophages VCAN+SPP1+")
rownames(pf_macrophages_tamannotation_meanranks_l4_rank_z) <- gsub("-", ".", rownames(pf_macrophages_tamannotation_meanranks_l4_rank_z))

pf_macrophages_tamannotation_meanranks_l4_rowanno <- data.frame(pf_macrophages_tamannotation_meanranks_l4[,c(1,2)], row.names = paste0(pf_macrophages_tamannotation_meanranks_l4$gene, "_", pf_macrophages_tamannotation_meanranks_l4$TAM))
pf_macrophages_tamannotation_meanranks_l4_rowanno <- pf_macrophages_tamannotation_meanranks_l4_rowanno[rownames(pf_macrophages_tamannotation_meanranks_l4_rank),]

pf_macrophages_tamannotation_meanranks_l4_rank[pf_macrophages_tamannotation_meanranks_l4_rank == -Inf] <- 0

pdf("heatmap_hc_pf_macrophages_tam_annotations_meanranks_l4.pdf", height = 30, width = 3.5)
#Heatmap(pf_macrophages_tamannotation_meanranks_l4_rank_z, 
Heatmap(pf_macrophages_tamannotation_meanranks_l4_rank, 
        col = PurpleAndYellow(1000),
        row_split = pf_macrophages_tamannotation_meanranks_l4_rowanno$TAM,
        cluster_columns = F,
) + 
  rowAnnotation(labels = anno_text(pf_macrophages_tamannotation_meanranks_l4_rowanno$gene, which = "row"))
dev.off()

pdf("heatmap_hc_pf_macrophages_tam_annotations_meanranks_l4_z_norown.pdf", height = 10, width = 3.5)
Heatmap(pf_macrophages_tamannotation_meanranks_l4_rank_z, 
        col = PurpleAndYellow(1000),
        row_split = pf_macrophages_tamannotation_meanranks_l4_rowanno$TAM,
        show_row_names = F, 
        cluster_columns = F) 
dev.off()
```

### UMAP HC PF, Liver, and Colon MNP SPP1, MARCO, CD163, CD1C expression

```{r umap hc pf liver colon mnp col_macrophagemarkers, fig.width = 15, fig.height = 20}
umap_hc_pf_liver_colon_mnp_colmacrophagesmarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_myeloid),
             Embeddings(seurat_pf_myeloid[["gex.umap"]]),
             manual_l2 = seurat_pf_myeloid@meta.data$manual_l2,
             manual_l3 = seurat_pf_myeloid@meta.data$manual_l3,
             expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["SPP1",],
             Feature = "SPP1",
             Tissue = "PF") %>%
    dplyr::rename(UMAP_1 = gexUMAP_1,
                  UMAP_2 = gexUMAP_2) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = 0, #Hotfix, else I get an error, there is no SPP1 in liver
                                  Feature = "SPP1",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["gex.umap"]]),
                                  manual_l2 = seurat_pf_myeloid@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_myeloid@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = gexUMAP_1,
                                       UMAP_2 = gexUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["gex.umap"]]),
                                  manual_l2 = seurat_pf_myeloid@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_myeloid@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = gexUMAP_1,
                                       UMAP_2 = gexUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_myeloid),
                                  Embeddings(seurat_pf_myeloid[["gex.umap"]]),
                                  manual_l2 = seurat_pf_myeloid@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_myeloid@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_myeloid, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = gexUMAP_1,
                                       UMAP_2 = gexUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Liver")) %>%
    dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    dplyr::filter(manual_l2 %in% c("Monocytes", "Macrophages", "CDCs", "PDCs")) %>%
    split(., list(.$Tissue, .$Feature)), FUN = function(plotdf){
      plotdf %>%
        dplyr::arrange(expr) %>%
        ggplot(aes(x = UMAP_1, y = UMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        #labs(title = "SPP1") +
        facet_grid(Feature~Tissue) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    })

print(ggarrange(plotlist = umap_hc_pf_liver_colon_mnp_colmacrophagesmarkers_ggplotobj_list, nrow = 4, ncol = 3))

pdf("umap_hc_pf_liver_colon_mnp_macrophagesmarkers.pdf", width = 3*3, height = 3*4)
print(ggarrange(plotlist = umap_hc_pf_liver_colon_mnp_colmacrophagesmarkers_ggplotobj_list, nrow = 4, ncol = 3))
dev.off()
```

### UMAP HC PF, Liver, and Colon monocytes macrophages C1QA, SPP1, MARCO, CD163, CD1C expression

```{r umap hc pf liver colon monocytes macrophages col_macrophagemarkers, fig.width = 15, fig.height = 20}
umap_hc_pf_liver_colon_monocytes_macrophages_colmacrophagesmarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_macrophages),
             Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
             manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
             manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
             expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["SPP1",],
             Feature = "SPP1",
             Tissue = "PF") %>%
    dplyr::rename(UMAP_1 = wnnUMAP_1,
                  UMAP_2 = wnnUMAP_2) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = 0, #Hotfix, else I get an error, there is no SPP1 in liver
                                  Feature = "SPP1",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "PF")  %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_mnp),
                                  Embeddings(seurat_colon_mnp[["umap"]]),
                                  manual_l2 = seurat_colon_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_mnp, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_mnp),
                                  Embeddings(seurat_liver_mnp[["umap"]]),
                                  manual_l2 = seurat_liver_mnp@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_mnp@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_mnp, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "Liver")) %>%
    dplyr::filter(manual_l2 %in% c("Monocytes", "Macrophages")) %>%
    dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    split(., list(.$Tissue, .$Feature)), FUN = function(plotdf){
      plotdf %>%
        dplyr::arrange(expr) %>%
        ggplot(aes(x = UMAP_1, y = UMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        facet_grid(Feature~Tissue) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_hc_pf_liver_colon_monocytes_macrophages_colmacrophagesmarkers_ggplotobj_list, nrow = 5, ncol = 3))

pdf("umap_hc_pf_liver_colon_monocytes_macrophages_macrophagesmarkers.pdf", width = 3*3, height = 3*5)
print(ggarrange(plotlist = umap_hc_pf_liver_colon_monocytes_macrophages_colmacrophagesmarkers_ggplotobj_list, nrow = 5, ncol = 3))
dev.off()
```

### UMAP HC PF, Liver, and Colon macrophages C1QA, SPP1, MARCO, CD163, CD1C expression

```{r umap hc pf liver colon macrophages col_macrophagemarkers, fig.width = 15, fig.height = 20}
umap_hc_pf_liver_colon_macrophages_colmacrophagesmarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_pf_macrophages),
             Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
             manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
             manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
             expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["SPP1",],
             Feature = "SPP1",
             Tissue = "PF") %>%
    dplyr::rename(UMAP_1 = wnnUMAP_1,
                  UMAP_2 = wnnUMAP_2) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_macrophages),
                                  Embeddings(seurat_colon_macrophages[["umap"]]),
                                  manual_l2 = seurat_colon_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_macrophages, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_macrophages),
                                  Embeddings(seurat_liver_macrophages[["umap"]]),
                                  manual_l2 = seurat_liver_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_macrophages@meta.data$manual_l3,
                                  expr = 0, #Hotfix, else I get an error, there is no SPP1 in liver
                                  Feature = "SPP1",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "PF")  %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_macrophages),
                                  Embeddings(seurat_colon_macrophages[["umap"]]),
                                  manual_l2 = seurat_colon_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_macrophages),
                                  Embeddings(seurat_liver_macrophages[["umap"]]),
                                  manual_l2 = seurat_liver_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_macrophages),
                                  Embeddings(seurat_colon_macrophages[["umap"]]),
                                  manual_l2 = seurat_colon_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_macrophages),
                                  Embeddings(seurat_liver_macrophages[["umap"]]),
                                  manual_l2 = seurat_liver_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Tissue = "Liver")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_macrophages),
                                  Embeddings(seurat_colon_macrophages[["umap"]]),
                                  manual_l2 = seurat_colon_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_macrophages, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_macrophages),
                                  Embeddings(seurat_liver_macrophages[["umap"]]),
                                  manual_l2 = seurat_liver_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_macrophages, assay = "RNA")["CD1C",],
                                  Feature = "CD1C",
                                  Tissue = "Liver")) %>% 
    dplyr::rows_append(data.frame(CB = colnames(seurat_pf_macrophages),
                                  Embeddings(seurat_pf_macrophages[["wnn.umap"]]),
                                  manual_l2 = seurat_pf_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_pf_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_pf_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "PF") %>%
                         dplyr::rename(UMAP_1 = wnnUMAP_1,
                                       UMAP_2 = wnnUMAP_2)) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_colon_macrophages),
                                  Embeddings(seurat_colon_macrophages[["umap"]]),
                                  manual_l2 = seurat_colon_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_colon_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_colon_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "Colon")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_liver_macrophages),
                                  Embeddings(seurat_liver_macrophages[["umap"]]),
                                  manual_l2 = seurat_liver_macrophages@meta.data$manual_l2,
                                  manual_l3 = seurat_liver_macrophages@meta.data$manual_l3,
                                  expr = GetAssayData(seurat_liver_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Tissue = "Liver")) %>%
    dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
    split(., list(.$Tissue, .$Feature)), FUN = function(plotdf){
      plotdf %>%
        dplyr::arrange(expr) %>%
        ggplot(aes(x = UMAP_1, y = UMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        facet_grid(Feature~Tissue) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.position = "none",
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)


print(ggarrange(plotlist = umap_hc_pf_liver_colon_macrophages_colmacrophagesmarkers_ggplotobj_list, nrow = 5, ncol = 3))

pdf("umap_hc_pf_liver_colon_macrophages_macrophagesmarkers.pdf", width = 3*3, height = 3*5)
print(ggarrange(plotlist = umap_hc_pf_liver_colon_macrophages_colmacrophagesmarkers_ggplotobj_list, nrow = 5, ncol = 3))
dev.off()
```

### Stackedbarplot HC PBMC, PF, Liver and Colon l2rl0 colored by l2

```{r stackedbarplot hc pbmc pf liver colon l2rl0 col_l2, fig.width=5, fig.height=5}
stackedbarplot_hc_pbmc_pf_liver_colon_l2rl0_coll2_ggplotobj <- seurat_pbmc_pf_liver_colon@meta.data %>%
  dplyr::group_by(manual_l2, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Tissue), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(Tissue) %>%
  dplyr::mutate(manual_l2 = factor(manual_l2, levels = celltype_order_l2$celltype),
                Nsample = sum(Ncells),
                Ncellprop = Ncells/Nsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
  dplyr::rename(Celltype = manual_l2) %>%
  ggplot(aes(x = Tissue, y = Ncellperc)) +
  geom_bar(position="stack", stat="identity", aes(fill = Celltype)) +
  labs(y = "%CD45+") +
  scale_fill_manual(values = manual_l2_colors) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(stackedbarplot_hc_pbmc_pf_liver_colon_l2rl0_coll2_ggplotobj)

# pdf("stackedbarplot_hc_pbmc_pf_liver_colon_l2rl0_coll2.pdf", width = 5, height = 5)
# print(stackedbarplot_hc_pbmc_pf_liver_colon_l2rl0_coll2_ggplotobj)
# dev.off()

# seurat_pbmc_pf_liver_colon@meta.data %>%
#   dplyr::group_by(manual_l2, Tissue, .drop = T) %>% 
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(Tissue), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(Tissue) %>%
#   dplyr::mutate(manual_l2 = factor(manual_l2, levels = celltype_order_l2$celltype),
#                 Nsample = sum(Ncells),
#                 Ncellprop = Ncells/Nsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
#   dplyr::rename(Celltype = manual_l2) %>%
#   readr::write_csv(file = "hc_pbmc_pf_liver_colon_l2rl0.csv") 
```

### Boxplot PF, Liver, and Colon l2rl0 colored by tissue

```{r boxplot HC PF, Liver, and Colon l2rl0 col_tissue, fig.width = 6, fig.height = 8}
boxplot_hc_pf_liver_colon_l2rl0_coltissue_ggplotobj <- seurat_pbmc_pf_liver_colon@meta.data %>%
  dplyr::filter(Tissue %in% c("PF", "Colon", "Liver")) %>%
  dplyr::group_by(manual_l2, Donor, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Tissue, Donor), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(Donor) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", Donor),
                Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
  ggplot(aes(x = Tissue, y = Ncellperc)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA, aes(col = Tissue)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~manual_l2, scales = "free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = tissue_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pf_liver_colon_l2rl0_coltissue_ggplotobj)

# pdf("boxplot_hc_pf_liver_colon_l2rl0_coltissue.pdf", width = 6, height = 8)
# print(boxplot_hc_pf_liver_colon_l2rl0_coltissue_ggplotobj)
# dev.off()

# seurat_pbmc_pf_liver_colon@meta.data %>%
#   dplyr::filter(Tissue %in% c("PF", "Colon", "Liver")) %>%
#   dplyr::group_by(manual_l2, Donor, Tissue, .drop = T) %>%
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(Tissue, Donor), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(Donor) %>%
#   dplyr::mutate(Nlrefsample = sum(Ncells),
#                 Ncellprop = Ncells/Nlrefsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", Donor),
#                 Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
#   readr::write_csv(file = "hc_pf_liver_colon_l2rl0.csv")
```

### Boxplot PF, Liver, and Colon l3rl0 colored by tissue

```{r boxplot HC PF, Liver, and Colon l3rl0 col_tissue, fig.width = 10, fig.height = 12.5}
boxplot_hc_pf_liver_colon_l3rl0_coltissue_ggplotobj <- seurat_pbmc_pf_liver_colon@meta.data %>%
  dplyr::filter(Tissue %in% c("PF", "Colon", "Liver")) %>%
  dplyr::group_by(manual_l3, Donor, Tissue, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Tissue, Donor), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(Donor) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", Donor),
                Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
  ggplot(aes(x = Tissue, y = Ncellperc)) +
  geom_boxplot(alpha = 0.5, outlier.shape = NA, aes(col = Tissue)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~manual_l3, scales = "free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = tissue_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_hc_pf_liver_colon_l3rl0_coltissue_ggplotobj)

# pdf("boxplot_hc_pf_liver_colon_l3rl0_coltissue.pdf", width = 15, height = 15)
# print(boxplot_hc_pf_liver_colon_l3rl0_coltissue_ggplotobj)
# dev.off()

seurat_pbmc_pf_liver_colon@meta.data %>%
  dplyr::filter(Tissue %in% c("PF", "Colon", "Liver")) %>%
  dplyr::group_by(manual_l3, Donor, Tissue, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Tissue, Donor), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(Donor) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", Donor),
                Tissue = factor(Tissue, levels = c("PBMC", "PF", "Colon", "Liver"))) %>%
  readr::write_csv(file = "hc_pf_liver_colon_l3rl0.csv")
```

### Jitteredviolinplot PF, Liver, and Colon macrophages SPP1, VSIG4, and C1QA colored by tissue

```{r jitteredviolinplot HC PF liver colon macrophage macrophage_marker col_tissue, fig.width = 7.5, fig.height = 3.5}
macrophage_marker_gex <- c("CD163", "VCAN", "C1QA", "SPP1", "VSIG4")

pf_liver_colon_macrophage_macrophage_marker_gex_norm <- GetAssayData(seurat_pf_liver_colon_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_liver_colon_macrophages, assay = "RNA", slot = "data")) %in% macrophage_marker_gex), ]

pf_liver_colon_macrophage_macrophage_marker_gex_norm <- FetchData(seurat_pf_liver_colon_macrophages, vars = macrophage_marker_gex)

jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj <- data.frame(FeatureID = colnames(pf_liver_colon_macrophage_macrophage_marker_gex), t(pf_liver_colon_macrophage_macrophage_marker_gex)) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_liver_colon_macrophages@meta.data), 
                               Celltype = seurat_pf_liver_colon_macrophages@meta.data[,"manual_l2"],
                               Tissue = seurat_pf_liver_colon_macrophages@meta.data[,"Tissue"],
                               Study = seurat_pf_liver_colon_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  ggplot(aes(x = Tissue, y = nUMIs, col = Tissue)) +
  geom_jitter_rast() +
  geom_violin() +
  facet_wrap(~FeatureID, nrow = 1) +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

print(dotplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)

pdf("jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker.pdf", width = 7.5, height = 3.5)
print(jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)
dev.off()
```

### Dotplot GEX HC Kidney colored by l2/l3

```{r dotplot gex hc kidney col_l2l3, fig.width = 7.25, fig.height=15}
marker_genes <- readxl::read_excel(pf_heatmap_order_xlsx) %>%
  dplyr::filter(Assay == "RNA")
marker_gex <- GetAssayData(seurat_pf_l2l3, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_l2l3, assay = "RNA")) %in% unique(marker_genes$FeatureID)), ]

dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj <- data.frame(FeatureID = rownames(marker_gex), marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_l2l3@meta.data), 
                               Celltype = seurat_pf_l2l3@meta.data[,"celltype"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype = factor(Celltype, celltype_order_pf_l2_l3$celltype),
                FeatureID = factor(FeatureID, rev(marker_genes$FeatureID))) %>% 
  ggplot(aes(x = Celltype, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj)

pdf("dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj.pdf", width = 7.5, height=15)
print(dotplot_hc_pf_l2l3_cellmarkers_gex_ggplotobj)
dev.off()
```

### Dotplot GEX HC PF, Liver, and Colon macrophages colored by markergenes

```{r dotplot gex hc pf col_cellmarkers, fig.width=2.25, fig.height=4.3}
macrophage_marker_gex <- c("CD163", "VCAN", "C1QA", "SPP1", "VSIG4")

pf_liver_colon_macrophage_macrophage_marker_gex <- GetAssayData(seurat_pf_liver_colon_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_liver_colon_macrophages, assay = "RNA")) %in% macrophage_marker_gex), ]

dotplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj <- data.frame(FeatureID = rownames(pf_liver_colon_macrophage_macrophage_marker_gex), pf_liver_colon_macrophage_macrophage_marker_gex) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-")) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_liver_colon_macrophages@meta.data), 
                               Celltype = seurat_pf_liver_colon_macrophages@meta.data[,"manual_l3"],
                               Tissue = seurat_pf_liver_colon_macrophages@meta.data[,"Tissue"],
                               Study = seurat_pf_liver_colon_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  dplyr::group_by(Celltype, FeatureID, Tissue, .drop = F) %>%
  dplyr::summarize(Median = median(log1p(nUMIs)),
                   Percentage = mean(nUMIs>0)*100) %>%
  dplyr::mutate(Median = ifelse(is.na(Median), 0, Median),
                Percentage = ifelse(is.na(Percentage), 0, Percentage),
                Celltype_tissue = paste0("(", Tissue, ") ", Celltype),
                #Celltype = factor(Celltype, manual_l3_order),
                FeatureID = factor(FeatureID, rev(macrophage_marker_gex))) %>% 
  ggplot(aes(x = Celltype_tissue, y = FeatureID, col = Median)) +
  geom_tile(alpha = 0, col = "grey") +
  geom_point(aes(size = Percentage)) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing.x=unit(0, "lines"))

print(dotplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)

# pdf("dotplot_hc_pf_liver_colon_macrophage_macrophage_marker.pdf", width = 6, height=15)
# print(dotplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)
# dev.off()
```

```{r}
VlnPlot(seurat_pf_liver_colon_macrophages, c("VSIG4", "SPP1", "C1QA"), group.by = "Tissue")
```

### Jitteredviolinplot CRC PF, Liver, and Colon macrophages SPP1, VSIG4, and C1QA colored by tissue

```{r jitteredviolinplot HC PF liver colon macrophage macrophage_marker col_tissue, fig.width = 7.5, fig.height = 3.5}
macrophage_marker_gex <- c("CD163", "VCAN", "C1QA", "SPP1", "VSIG4")

pf_liver_colon_macrophage_macrophage_marker_gex_norm <- GetAssayData(seurat_crc_pf_liver_colon_macrophages, assay = "RNA")[which(rownames(GetAssayData(seurat_pf_liver_colon_macrophages, assay = "RNA", slot = "data")) %in% macrophage_marker_gex), ]

pf_liver_colon_macrophage_macrophage_marker_gex_norm <- FetchData(seurat_pf_liver_colon_macrophages, vars = macrophage_marker_gex)

jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj <- data.frame(FeatureID = colnames(pf_liver_colon_macrophage_macrophage_marker_gex), t(pf_liver_colon_macrophage_macrophage_marker_gex)) %>%
  tidyr::pivot_longer(-c(FeatureID), names_to = "CB", values_to = "nUMIs") %>%
  dplyr::mutate(CB = stringr::str_replace(CB, "\\.", "-"),
                nUMIs = log1p(nUMIs)) %>%
  dplyr::inner_join(data.frame(CB = rownames(seurat_pf_liver_colon_macrophages@meta.data), 
                               Celltype = seurat_pf_liver_colon_macrophages@meta.data[,"manual_l2"],
                               Tissue = seurat_pf_liver_colon_macrophages@meta.data[,"Tissue"],
                               Study = seurat_pf_liver_colon_macrophages@meta.data[,"Study"]), 
                    by = "CB") %>%
  dplyr::mutate(Celltype = factor(Celltype), 
                FeatureID = factor(FeatureID)) %>%
  ggplot(aes(x = Tissue, y = nUMIs, col = Tissue)) +
  geom_jitter_rast() +
  geom_violin(trim = F, scale = "width") +
  facet_wrap(~FeatureID, nrow = 1) +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

print(dotplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)

pdf("jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker.pdf", width = 7.5, height = 3.5)
print(jitteredviolinplot_hc_pf_liver_colon_macrophage_macrophage_marker_ggplotobj)
dev.off()
```
