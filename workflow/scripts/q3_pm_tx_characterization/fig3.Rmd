---
title: 'Figure 3: TIME of PM-CRC'
author: "Andrew Y.F. Li Yim"
date: '2023-07-31'
output: html_document
---

```{r libraries, include=FALSE}
library(Seurat)
library(ggplot2)
library(dplyr)
library(ggrastr)
library(ggrepel)
library(ggpubr)
library(viridis)
library(SummarizedExperiment)
library(slingshot)
library(SingleCellExperiment)
library(DESeq2)
library(ggdendro)
library(ggalt)
```

If the snakemake pipeline was run as-is, the following files will be generated in the folder from which the pipeline was run. If not, then adjust paths accordingly.    

## Setup

### Paths

```{r paths}
#base_path <- "/media/hdd1/andrewliyim/maps_crc" # local drive
base_path <- "/mnt/smb/ltytgat/ayliyim/MI-group/ayliyim/projects/TIPRJ0000015_MAPS/maps_crc" # L-drive

# Subsets
seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_SeuratObject.Rds")
seurat_crcpmp_tx_monocytes_macrophages_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_monocytes_macrophages_SeuratObject.Rds")

seurat_crcpmp_pf_tx_paired_immune_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_pf_tx_paired_immune_SeuratObject.Rds")
seurat_crcpmp_pf_tx_paired_macrophages_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_pf_tx_paired_macrophages_SeuratObject.Rds")
seurat_crcpmp_tx_immune_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_immune_SeuratObject.Rds")
seurat_crcpmp_tx_macrophages_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_macrophages_SeuratObject.Rds")

# Analyses
txvpf_paired_degs_l4_rds <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_txvpf_manual_l4_deseq2_list.Rds")

tam_markers_xlsx <- file.path(base_path, "config/genes_of_interest/tams_ma_2022.xlsx")
crcpmp_pf_tx_paired_macrophages_tamannotation_rds <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_pf_tx_paired_macrophages_tamannotation.Rds")

crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce.Rds")
crcpmp_pf_tx_paired_monocytes_macrophages_aggregated_lines_csv <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_aggregated_lines.csv")
crcpmp_pf_tx_paired_monocytes_macrophages_tscan_rootcl1_rds <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_tscan_rootcl1.Rds")

crcpmp_tx_monocytes_macrophages_trajectory_sce_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_monocytes_macrophages_trajectory_sce.Rds")
crcpmp_tx_monocytes_macrophages_trajectory_aggregated_lines_csv <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_tx_monocytes_macrophages_trajectory_aggregated_lines.csv")
crcpmp_tx_monocytes_macrophages_trajectory_tscan_rootclassicalmonocytes_rds <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_tx_monocytes_macrophages_trajectory_tscan_rootclassicalmonocytes.Rds")

crcpmp_tx_macrophages_trajectory_sce_rds <- file.path(base_path, "output/q3_pm_tx_characterization/subsets/crcpmp_tx_macrophages_trajectory_sce.Rds")
crcpmp_tx_macrophages_trajectory_aggregated_lines_csv <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_tx_macrophages_trajectory_aggregated_lines.csv")
crcpmp_tx_macrophages_trajectory_tscan_rootmacrophagesvcan_rds <- file.path(base_path, "output/q3_pm_tx_characterization/analyses/crcpmp_tx_macrophages_trajectory_tscan_rootmacrophagesvcan.Rds")

# Plotting parameters
celltype_markers_xlsx <- file.path(base_path, "config/order/celltype_markers.xlsx")
azizi2018_xlsx <- file.path(base_path, "config/genes_of_interest/m1_m2_azizi2018.xlsx")
```

### Import data

```{r load subsets}
seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- readRDS(seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_rds)
seurat_crcpmp_pf_tx_paired_immune <- readRDS(seurat_crcpmp_pf_tx_paired_immune_rds)
seurat_crcpmp_pf_tx_paired_macrophages <- readRDS(seurat_crcpmp_pf_tx_paired_macrophages_rds)
seurat_crcpmp_tx_immune <- readRDS(seurat_crcpmp_tx_immune_rds)
seurat_crcpmp_tx_monocytes_macrophages <- readRDS(seurat_crcpmp_tx_monocytes_macrophages_rds)
seurat_crcpmp_tx_macrophages <- readRDS(seurat_crcpmp_tx_macrophages_rds)

crcpmp_pf_tx_paired_macrophages_tamannotation <- readRDS(crcpmp_pf_tx_paired_macrophages_tamannotation_rds)

crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce <- readRDS(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce_rds)
crcpmp_pf_tx_paired_monocytes_macrophages_aggregated_lines <- read.csv(crcpmp_pf_tx_paired_monocytes_macrophages_aggregated_lines_csv)
crcpmp_pf_tx_paired_monocytes_macrophages_tscan_rootcl1 <- readRDS(crcpmp_pf_tx_paired_monocytes_macrophages_tscan_rootcl1_rds)

crcpmp_tx_monocytes_macrophages_trajectory_sce <- readRDS(crcpmp_tx_monocytes_macrophages_trajectory_sce_rds)
crcpmp_tx_monocytes_macrophages_aggregated_lines <- read.csv(crcpmp_tx_monocytes_macrophages_trajectory_aggregated_lines_csv)
crcpmp_tx_monocytes_macrophages_tscan_rootclassicalmonocytes <- readRDS(crcpmp_tx_monocytes_macrophages_trajectory_tscan_rootclassicalmonocytes_rds)

crcpmp_tx_macrophages_trajectory_sce <- readRDS(crcpmp_tx_macrophages_trajectory_sce_rds)
crcpmp_tx_macrophages_aggregated_lines <- read.csv(crcpmp_tx_macrophages_trajectory_aggregated_lines_csv)
crcpmp_tx_macrophages_tscan_rootmacrophagesvcan <- readRDS(crcpmp_tx_macrophages_trajectory_tscan_rootmacrophagesvcan_rds)
```

```{r load de analyses}
txvpf_paired_degs_l4 <- readRDS(txvpf_paired_degs_l4_rds)
```

```{r load macrophage markers}
m1_markers <- readxl::read_excel(azizi2018_xlsx, sheet = 2)
m2_markers <- readxl::read_excel(azizi2018_xlsx, sheet = 3)
```

### Plotting parameters

```{r plotting order}
celltype_order_l2 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l2",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l3 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l4 <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l3_tx_immune <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l3",
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color),
                celltype %in% seurat_crcpmp_tx_immune$manual_l3) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l4_monocytes_macrophages <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                celltype %in% c("Classical monocytes", "Non-classical monocytes", "Macrophages C1Q+", "Macrophages C1Q+SPP1+", "Macrophages VCAN+", "Macrophages VCAN+SPP1+", "Macrophages VCAN+C1Q+"),
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))

celltype_order_l4_macrophages <- readxl::read_excel(celltype_markers_xlsx, col_names = T) %>%
  dplyr::filter(level == "manual_l4",
                celltype %in% c("Macrophages C1Q+", "Macrophages C1Q+SPP1+", "Macrophages VCAN+", "Macrophages VCAN+SPP1+", "Macrophages VCAN+C1Q+"),
                modality == "gene") %>%
  dplyr::select(celltype, color) %>%
  unique() %>%
  dplyr::filter(!is.na(color)) %>%
  dplyr::mutate(number_subset = paste0(1:nrow(.), ". ", celltype))
```

```{r colors}
tissue_colors <- c(PBMC = "#F30000", PF = "#224FBD", TX = "#808080")

manual_l2_colors <- celltype_order_l2$color
names(manual_l2_colors) <- celltype_order_l2$celltype

manual_l3_colors <- celltype_order_l3$color
names(manual_l3_colors) <- celltype_order_l3$celltype

manual_l4_colors <- celltype_order_l4$color
names(manual_l4_colors) <- celltype_order_l4$celltype

manual_l2_number_colors <- celltype_order_l2$color
names(manual_l2_number_colors) <- celltype_order_l2$number_subset

manual_l3_number_colors <- celltype_order_l3$color
names(manual_l3_number_colors) <- celltype_order_l3$number_subset

manual_l3_tx_immune_colors <- celltype_order_l3_tx_immune$color
names(manual_l3_tx_immune_colors) <- celltype_order_l3_tx_immune$number_subset

manual_l4_monocytes_macrophages_number_colors <- celltype_order_l4_monocytes_macrophages$color
names(manual_l4_monocytes_macrophages_number_colors) <- celltype_order_l4_monocytes_macrophages$number_subset

manual_l4_macrophages_number_colors <- celltype_order_l4_macrophages$color
names(manual_l4_macrophages_number_colors) <- celltype_order_l4_macrophages$number_subset
```

## Figures

### UMAP PM-CRC PF and TX colored by l3

```{r umap hc crcpmp pf col_l3, fig.width=8, fig.height=9}
umap_crcpmp_pf_tx_paired_l3_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_pf_tx_paired_immune ),
                                                    Embeddings(seurat_crcpmp_pf_tx_paired_immune [["umap"]]),
                                                    seurat_crcpmp_pf_tx_paired_immune@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l3$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_number_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_pf_tx_paired_l3_ggplotobj)

# pdf("umap_crcpmp_pf_tx_paired_l2.pdf", width = 8, height=9)
# print(umap_crcpmp_pf_tx_paired_l2_ggplotobj)
# dev.off()
```

### UMAP PM-CRC TX colored by l3

```{r umap hc crcpmp tx col_l3, fig.width=8, fig.height=9}
umap_crcpmp_tx_coll3_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_tx_immune),
                                             Embeddings(seurat_crcpmp_tx_immune[["umap"]]),
                                             seurat_crcpmp_tx_immune@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_l3_tx_immune$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l3_tx_immune$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype)) +
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_tx_coll3_ggplotobj)

# pdf("umap_crcpmp_tx_coll3.pdf", width = 8, height=9)
pdf("umap_crcpmp_tx_coll3.pdf", width = 7.5, height=7.5)
print(umap_crcpmp_tx_coll3_ggplotobj)
dev.off()
```

### UMAP PM-CRC TX colored by l3 labeled by l3

```{r umap hc crcpmp tx col_l3 lab_l3, fig.width=8, fig.height=9}
umap_crcpmp_tx_coll3_labl3_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_tx_immune),
                                                   Embeddings(seurat_crcpmp_tx_immune[["umap"]]),
                                                   seurat_crcpmp_tx_immune@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l3, levels = celltype_order_l3_tx_immune$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l3_tx_immune$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 0.25, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1, 
                   size = 8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l3_tx_immune_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_tx_l3_ggplotobj)

# pdf("umap_crcpmp_tx_coll3_labl3.pdf", width = 8, height=9)
pdf("umap_crcpmp_tx_coll3_labl3.pdf", width = 7.5, height=7.5)
print(umap_crcpmp_tx_coll3_labl3_ggplotobj)
dev.off()
```

### Hierarchical clustering PBMC, PF, and TX monocytes and macrophages per donor

```{r dendrogram eucdist crcpmp pbmc pf tx paired monocytes macrophages donor, fig.width = 15, fig.height = 7.5}
counts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- GetAssayData(seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages, slot = "counts")

seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_donor_l4 <- paste0(seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages@meta.data$Donor, "_", seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages@meta.data$Tissue, "_", seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages@meta.data$manual_l4)

pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- counts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages %*% model.matrix(~0+seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_donor_l4)
colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages) <- gsub("seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_donor_l4", "", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages))

pseudosamplemetadata_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- data.frame(
  row.names = colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages),
  Donor = gsub("(pt[0-9]+)_.+_.+$", "\\1", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)),
  Tissue = gsub("pt[0-9]+_(.+)_.+$", "\\1", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)),
  Celltype = gsub("pt[0-9]+_.+_(.+)$", "\\1", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages))
)

dds_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- DESeqDataSetFromMatrix(
  countData = pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages,
  colData = pseudosamplemetadata_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages,
  design = ~1)

vst_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- vst(dds_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)

eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- dist(t(assay(vst_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)), method = 'euclidean')

eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_hclust <- hclust(eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)

pdf("dendrogram_eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages.pdf", width = 15, height = 10)
ggdendrogram(eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_hclust)
dev.off()
```

### Hierarchical clustering PBMC, PF, and TX monocytes and macrophages per tissue

```{r dendrogram eucdist crcpmp pbmc pf tx paired monocytes macrophages, fig.width = 5, fig.height = 5}
counts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- GetAssayData(seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages, slot = "counts")

seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_l4 <- paste0(seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages@meta.data$Tissue, "_", seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages@meta.data$manual_l4)

pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- counts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages %*% model.matrix(~0+seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_l4)
colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages) <- gsub("seurat_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_l4", "", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages))

pseudosamplemetadata_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- data.frame(
  row.names = colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages),
  Tissue = gsub("pt[0-9]+_(.+)_.+$", "\\1", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)),
  Celltype = gsub("pt[0-9]+_.+_(.+)$", "\\1", colnames(pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages))
)

dds_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- DESeqDataSetFromMatrix(
  countData = pseudocounts_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages,
  colData = pseudosamplemetadata_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages,
  design = ~1)

vst_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- vst(dds_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)

eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages <- dist(t(assay(vst_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)), method = 'euclidean')

eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_hclust <- hclust(eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages)

pdf("dendrogram_eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages.pdf", width = 5, height = 5)
ggdendrogram(eucdist_crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_hclust)
dev.off()
```

### Hierarchical clustering TX macrophages per tissue

```{r dendrogram eucdist crcpmp pbmc pf tx paired monocytes macrophages, fig.width = 1.5, fig.height = 3}
counts_crcpmp_tx_macrophages <- GetAssayData(seurat_crcpmp_tx_macrophages, slot = "counts")

pseudocounts_crcpmp_tx_macrophages <- counts_crcpmp_tx_macrophages %*% model.matrix(~0+seurat_crcpmp_tx_macrophages@meta.data$manual_l4)
colnames(pseudocounts_crcpmp_tx_macrophages) <- gsub("seurat_crcpmp_tx_macrophages@meta\\.data\\$manual_l4", "", colnames(pseudocounts_crcpmp_tx_macrophages))

pseudosamplemetadata_crcpmp_tx_macrophages <- data.frame(
  row.names = colnames(pseudocounts_crcpmp_tx_macrophages),
  Tissue = "TX",
  Celltype = gsub("pt[0-9]+_.+_(.+)$", "\\1", colnames(pseudocounts_crcpmp_tx_macrophages))
)

dds_crcpmp_tx_macrophages <- DESeqDataSetFromMatrix(
  countData = pseudocounts_crcpmp_tx_macrophages,
  colData = pseudosamplemetadata_crcpmp_tx_macrophages,
  design = ~1)

vst_crcpmp_tx_macrophages <- vst(dds_crcpmp_tx_macrophages)

eucdist_crcpmp_tx_macrophages <- dist(t(assay(vst_crcpmp_tx_macrophages)), method = 'euclidean')

eucdist_crcpmp_tx_macrophages_hclust <- hclust(eucdist_crcpmp_tx_macrophages)

pdf("dendrogram_eucdist_crcpmp_tx_macrophages_pertissue.pdf", width = 1.5, height = 3.5)
ggdendrogram(eucdist_crcpmp_tx_macrophages_hclust)
dev.off()
```

### Hierarchical clustering TX macrophages per tissue

```{r dendrogram eucdist crcpmp pbmc pf tx paired monocytes macrophages, fig.width = 3, fig.height = 3}
counts_crcpmp_tx_macrophages_donor <- GetAssayData(seurat_crcpmp_tx_macrophages, slot = "counts")

seurat_crcpmp_tx_macrophages_donor_l4 <- paste0(seurat_crcpmp_tx_macrophages@meta.data$Donor, "_", seurat_crcpmp_tx_macrophages@meta.data$manual_l4)

pseudocounts_tx_macrophages_donor <- counts_crcpmp_tx_macrophages_donor %*% model.matrix(~0+seurat_crcpmp_tx_macrophages_donor_l4)
colnames(pseudocounts_tx_macrophages_donor) <- gsub("seurat_crcpmp_tx_macrophages_donor_l4", "", colnames(pseudocounts_tx_macrophages_donor))

pseudosamplemetadata_crcpmp_tx_macrophages_donor <- data.frame(
  row.names = colnames(pseudocounts_tx_macrophages_donor),
  Tissue = "TX",
  Donor = gsub("(pt[0-9]+)_.+$", "\\1", colnames(pseudocounts_tx_macrophages_donor)),
  Celltype = gsub("pt[0-9]+_(.+)$", "\\1", colnames(pseudocounts_tx_macrophages_donor))
)

dds_crcpmp_tx_macrophages_donor <- DESeqDataSetFromMatrix(
  countData = pseudocounts_tx_macrophages_donor,
  colData = pseudosamplemetadata_crcpmp_tx_macrophages_donor,
  design = ~1)

vst_crcpmp_tx_macrophages_donor <- vst(dds_crcpmp_tx_macrophages_donor)

eucdist_crcpmp_tx_macrophages_donor <- dist(t(assay(vst_crcpmp_tx_macrophages_donor)), method = 'euclidean')

eucdist_crcpmp_tx_macrophages_donor_hclust <- hclust(eucdist_crcpmp_tx_macrophages_donor)

pdf("dendrogram_eucdist_crcpmp_tx_macrophages_perdonor.pdf", width = 5, height = 3.5)
ggdendrogram(eucdist_crcpmp_tx_macrophages_donor_hclust)
dev.off()
```


### UMAP PM-CRC TX monocytes and macrophages colored by l4

```{r umap crcpmp pf monocytes macrophages col_l4, fig.width=5, fig.height=5}
umap_crcpmp_tx_monocytes_macrophages_l4_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                                                Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                                                seurat_crcpmp_tx_monocytes_macrophages@meta.data) %>%
  dplyr::mutate(Group = factor(Group, levels = c("HC", "CRC+")),
                celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 2, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1, 
                   size = 8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_monocytes_macrophages_number_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_tx_monocytes_macrophages_l4_ggplotobj)

#pdf("umap_crcpmp_tx_monocytes_macrophages_l4.pdf", width = 7.5, height = 7.5)
pdf("umap_crcpmp_tx_monocytes_macrophages_l4_5x5.pdf", width = 5, height = 5)
print(umap_crcpmp_tx_monocytes_macrophages_l4_ggplotobj)
dev.off()
```

### UMAP PM-CRC TX monocytes and macrophages colored by myeloid markers

```{r umap crcpmp tx monocytes macrophages col_myeloidmarkers, fig.width=12, fig.height=12}
umap_crcpmp_tx_monocytes_macrophages_colmyeloidgenemarkers_ggplotobj_list <- lapply(
  data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
             Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
             seurat_crcpmp_tx_monocytes_macrophages@meta.data,
             expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CD1C",],
             Feature = "CD1C",
             Modality = "RNA") %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CLEC9A",],
                                  Feature = "CLEC9A",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CLEC4C",],
                                  Feature = "CLEC4C",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["SPP1",],
                                  Feature = "SPP1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["MARCO",],
                                  Feature = "MARCO",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CD163",],
                                  Feature = "CD163",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["VCAN",],
                                  Feature = "VCAN",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["C1QA",],
                                  Feature = "C1QA",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["VSIG4",],
                                  Feature = "VSIG4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["TREM2",],
                                  Feature = "TREM2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["FN1",],
                                  Feature = "FN1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CSF1R",],
                                  Feature = "CSF1R",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["ITGAM",],
                                  Feature = "ITGAM",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["ITGAX",],
                                  Feature = "ITGAX",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CD14",],
                                  Feature = "CD14",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["GATA6",],
                                  Feature = "GATA6",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["TIMD4",],
                                  Feature = "TIMD4",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["MRC1",],
                                  Feature = "MRC1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["CCR2",],
                                  Feature = "CCR2",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["LYVE1",],
                                  Feature = "LYVE1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["XCR1",],
                                  Feature = "XCR1",
                                  Modality = "RNA")) %>%
    dplyr::rows_append(data.frame(CB = colnames(seurat_crcpmp_tx_monocytes_macrophages),
                                  Embeddings(seurat_crcpmp_tx_monocytes_macrophages[["umap"]]),
                                  seurat_crcpmp_tx_monocytes_macrophages@meta.data,
                                  expr = GetAssayData(seurat_crcpmp_tx_monocytes_macrophages, assay = "RNA")["S100A8",],
                                  Feature = "S100A8",
                                  Modality = "RNA")) %>%
    dplyr::mutate(expr_rank = rank(expr, ties.method="first"),
                  Feature = factor(Feature, levels = c("CD1C", "CLEC9A", "CLEC4C", "SPP1", "MARCO", "CD163", "VCAN", "C1QA", "VSIG4", "TREM2", "FN1", "CSF1R", "ITGAM", "ITGAX", "CD14", "GATA6", "TIMD4", "MRC1", "CCR2", "LYVE1", "XCR1", "S100A8")),
                  celltype = factor(manual_l4, levels = celltype_order_l4$celltype),
                  celltype_number = as.numeric(celltype),
                  celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                  celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>%
    split(., .$Feature), FUN = function(plotdf){
      plotdf %>% dplyr::arrange(expr) %>%
        ggplot(aes(x = UMAP_1, y = UMAP_2)) +
        geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
        geom_point_rast(data = . %>%
                          dplyr::filter(expr>0), aes(col = expr), show.legend = T) +
        guides(colour = guide_legend(override.aes = list(size = 3))) +
        facet_wrap(~Feature) +
        guides(colour = guide_legend(override.aes = list(size = 3),
                                     title = "Expression")) +
        scale_color_viridis() +
        #scale_colour_gradient(low = "#ffffff", high = "#FF0000") +
        theme_bw() +
        theme(panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              legend.pos = "none",
              # axis.text.x = element_blank(),
              # axis.ticks.x = element_blank(),
              axis.title.x = element_blank(),
              # axis.text.y = element_blank(),
              # axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              strip.text.x = element_text(face = "bold"))
    }
)

print(ggarrange(plotlist = umap_crcpmp_tx_monocytes_macrophages_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))

pdf("umap_crcpmp_tx_monocytes_macrophages_colmyeloidgenemarkers_colviridis.pdf", width = 15, height = 15)
print(ggarrange(plotlist = umap_crcpmp_tx_monocytes_macrophages_colmyeloidgenemarkers_ggplotobj_list, nrow = 5, ncol = 5))
dev.off()
```

### UMAP PM-CRC TX monocytes macrophages colored pseudotime (rooted at Classical monocytes)

```{r umap crcpmp tx monocytes macrophages col_pseudotime trajectory, fig.width=7.5, fig.height=7.5}
umap_crcpmp_tx_monocytes_macrophages_l4_colpseudotime_ggplotobj <- data.frame(CB = colnames(crcpmp_tx_monocytes_macrophages_trajectory_sce),
                                                                    reducedDim(crcpmp_tx_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                    colData(crcpmp_tx_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  dplyr::arrange(Pseudotime) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Pseudotime)) +
  geom_line(data = crcpmp_tx_monocytes_macrophages_aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge), linewidth = 2) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   # alpha = 0.75,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_viridis() +
  scale_colour_gradient(low = "#C7E9C0", high = "#005A32") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_tx_monocytes_macrophages_l4_colpseudotime.pdf", width = 5, height=5.5)
print(umap_crcpmp_tx_monocytes_macrophages_l4_colpseudotime_ggplotobj)
dev.off()
```

### UMAP PM-CRC TX macrophages colored by l4

```{r umap hc crcpmp tx macrophages col_l4, fig.width=5, fig.height=5}
umap_crcpmp_tx_macrophages_l4_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_tx_macrophages),
                                                      Embeddings(seurat_crcpmp_tx_macrophages[["umap"]]),
                                                      seurat_crcpmp_tx_macrophages@meta.data) %>%
  dplyr::mutate(Group = factor(Group, levels = c("HC", "CRC+")),
                celltype = factor(manual_l4, levels = celltype_order_l4_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 1, aes(col = celltype_w_number)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1, 
                   size = 8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_macrophages_number_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_tx_macrophages_l4_ggplotobj)

#pdf("umap_crcpmp_tx_macrophages_l4.pdf", width = 7.5, height = 7.5)
pdf("umap_crcpmp_tx_macrophages_l4_5x5.pdf", width = 5, height = 5)
print(umap_crcpmp_tx_macrophages_l4_ggplotobj)
dev.off()
```

### UMAP PM-CRC TX macrophages colored pseudotime (rooted at Macrophages VCAN+)

```{r umap crcpmp tx macrophages col_pseudotime trajectory, fig.width=7.5, fig.height=7.5}
umap_crcpmp_tx_macrophages_l4_colpseudotime_ggplotobj <- data.frame(CB = colnames(crcpmp_tx_macrophages_trajectory_sce),
                                                                    reducedDim(crcpmp_tx_macrophages_trajectory_sce , "UMAP"),
                                                                    colData(crcpmp_tx_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_macrophages$number_subset)) %>% 
  dplyr::arrange(Pseudotime) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Pseudotime)) +
  geom_line(data = crcpmp_tx_macrophages_aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge), linewidth = 2) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   # alpha = 0.75,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_viridis() +
  scale_colour_gradient(low = "#C7E9C0", high = "#005A32") +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_tx_macrophages_l4_colpseudotime.pdf", width = 5, height=5.5)
print(umap_crcpmp_tx_macrophages_l4_colpseudotime_ggplotobj)
dev.off()
```

### UMAP PM-CRC PF TX macrophages colored by Tissue

```{r umap hc crcpmp pf tx paired macrophages col_l4, fig.width=5, fig.height=5}
umap_crcpmp_pf_tx_paired_macrophages_l4_ggplotobj <- data.frame(CB = colnames(seurat_crcpmp_pf_tx_paired_macrophages),
                                                                Embeddings(seurat_crcpmp_pf_tx_paired_macrophages[["umap"]]),
                                                                seurat_crcpmp_pf_tx_paired_macrophages@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_point_rast(show.legend = T, size = 0.5, col = "black") +
  geom_point_rast(show.legend = T, size = 1, aes(col = Tissue)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1, 
  #                  size = 8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = tissue_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_pf_tx_paired_macrophages_l4_ggplotobj)

#pdf("umap_crcpmp_pf_tx_macrophages_coltissue.pdf", width = 7.5, height = 7.5)
pdf("umap_crcpmp_pf_tx_macrophages_coltissue_5x5.pdf", width = 5, height = 5)
print(umap_crcpmp_pf_tx_paired_macrophages_l4_ggplotobj)
dev.off()
```

### UMAP HC PM-CRC PF macrophages colored by Donor

```{r umap hc crcpmp pf macrophages col_l4, fig.width=5, fig.height=5}
umap_hc_crcpmp_pf_macrophages_coldonor_ggplotobj <- data.frame(CB = colnames(seurat_hc_crcpmp_pf_macrophages),
                                                               Embeddings(seurat_hc_crcpmp_pf_macrophages[["umap"]]),
                                                               seurat_hc_crcpmp_pf_macrophages@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = macrophages_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number)) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, col = Donor, partition = Donor)) +
  geom_point_rast(show.legend = T, size = 0.25) * (blend("lighten") + blend("multiply", alpha = 0.5))+
  labs(y = "",
       x = "") +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  #scale_color_manual(values = group_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_crcpmp_pf_macrophages_coldonor_ggplotobj)

# pdf("umap_hc_crcpmp_pf_macrophages_coldonor.pdf", width = 7.5, height=7.5)
# print(umap_hc_crcpmp_pf_macrophages_coldonor_ggplotobj)
# dev.off()
```

```{r heatmap hc crcpmp pf macrophages col_l4, fig.width=3.5, fig.height=10}
umap_hc_crcpmp_pf_macrophages_df <- data.frame(CB = colnames(seurat_hc_crcpmp_pf_macrophages),
                                               Embeddings(seurat_hc_crcpmp_pf_macrophages[["umap"]]),
                                               seurat_hc_crcpmp_pf_macrophages@meta.data) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = macrophages_order_pf_l4$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number))

pheatmap::pheatmap(prop.table(table(umap_hc_crcpmp_pf_macrophages_df$Donor, umap_hc_crcpmp_pf_macrophages_df$manual_l4), margin = 2), display_numbers = T)
```

### UMAP HC PM-CRC PF macrophages colored by Donor

```{r umap hc crcpmp pf macrophages col_markers, fig.width=9, fig.height=3.5}
umap_hc_crcpmp_pf_macrophages_markers_ggplotobj <- data.frame(CB = colnames(seurat_hc_crcpmp_pf_macrophages),
                                                              Embeddings(seurat_hc_crcpmp_pf_macrophages[["umap"]]),
                                                              seurat_hc_crcpmp_pf_macrophages@meta.data,
                                                              expr = GetAssayData(seurat_hc_crcpmp_pf_macrophages, assay = "RNA")["C1QA",],
                                                              Gene = "C1QA") %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_hc_crcpmp_pf_macrophages),
                                Embeddings(seurat_hc_crcpmp_pf_macrophages[["umap"]]),
                                seurat_hc_crcpmp_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_hc_crcpmp_pf_macrophages, assay = "RNA")["VCAN",],
                                Gene = "VCAN"))  %>%
  dplyr::rows_append(data.frame(CB = colnames(seurat_hc_crcpmp_pf_macrophages),
                                Embeddings(seurat_hc_crcpmp_pf_macrophages[["umap"]]),
                                seurat_hc_crcpmp_pf_macrophages@meta.data,
                                expr = GetAssayData(seurat_hc_crcpmp_pf_macrophages, assay = "RNA")["SPP1",],
                                Gene = "SPP1")) %>%
  dplyr::mutate(Gene = factor(Gene, levels = c("VCAN", "C1QA", "SPP1")),
                expr_rank = rank(expr, ties.method="first"),
                celltype = factor(manual_l3, levels = celltype_order_pf_l3$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_pf_l3$number_subset)) %>%
  ggplot(aes(x = UMAP_1, y = UMAP_2, order = expr_rank)) +
  geom_point_rast(show.legend = F, size = 0.25, col = "#d3d3d3") +
  geom_point_rast(data = . %>%
                    dplyr::filter(expr>0), aes(col = expr), show.legend = T, size = 0.25) +
  facet_wrap(~Gene, ncol = 3) +
  #labs(title = "Gene expression") +
  guides(colour = guide_legend(override.aes = list(size = 3),
                               title = "Expression")) +
  scale_color_viridis() +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_hc_crcpmp_pf_macrophages_markers_ggplotobj)

# pdf("umap_hc_crcpmp_pf_macrophages_markers.pdf", width = 9, height=3.5)
# print(umap_hc_crcpmp_pf_macrophages_markers_ggplotobj)
# dev.off()
```

### Stackedbarplot PM-CRC PF macrophages colored by l4

```{r stackedbarplot crcpmp pf macrophages col_l4, fig.width=3, fig.height=5}
stackedbarplot_crcpmp_pf_macrophages_coll4_ggplotobj <- seurat_hc_crcpmp_pf_macrophages@meta.data %>%
  dplyr::group_by(manual_l4, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(Group) %>%
  dplyr::mutate(manual_l4 = factor(manual_l4, levels = macrophages_order_pf_l4$celltype),
                Nsample = sum(Ncells),
                Ncellprop = Ncells/Nsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  dplyr::rename(Celltype = manual_l4) %>%
  ggplot(aes(x = Group, y = Ncellperc)) +
  geom_bar(position="stack", stat="identity", aes(fill = Celltype)) +
  labs(y = "%Macrophages") +
  scale_fill_manual(values = manual_l4_colors_pf_macrophages) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(stackedbarplot_crcpmp_pf_macrophages_coll4_ggplotobj)

# pdf("stackedbarplot_crcpmp_pf_macrophages_coll4.pdf", width = 3, height = 5)
# print(stackedbarplot_crcpmp_pf_macrophages_coll4_ggplotobj)
# dev.off()

# seurat_hc_crcpmp_pf_macrophages@meta.data %>%
#   dplyr::group_by(manual_l4, Group, .drop = T) %>% 
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(Group), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(Group) %>%
#   dplyr::mutate(manual_l4 = factor(manual_l4, levels = macrophages_order_pf_l4$celltype),
#                 Nsample = sum(Ncells),
#                 Ncellprop = Ncells/Nsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Group = factor(Group, levels = c("HC", "CRC+"))) %>%
#   dplyr::rename(Celltype = manual_l4) %>%
#   readr::write_csv(file = "crcpmp_pf_macrophages.csv")
```

### Heatmap PM-CRC vs HC PF macrophages M1 M2 markers colored by tstat

```{r heatmap crcpmpvhc pf l4 m1 m2 markers col_tstat, fig.width = 3, fig.height = 7}
macrophage_markers <- data.frame(gene = c(m1_markers$HGNC, m2_markers$HGNC),
                                 set = c(rep("M1", length(m1_markers$HGNC)), rep("M2", length(m2_markers$HGNC))))

heatmap_crcpmpvhc_pf_l4_goi_ggplotobj <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  degs_pf_l4_crcpmpvhc[[macrophage]]$degs %>%
    data.frame() %>%
    dplyr::filter(gene %in% macrophage_markers$gene) %>%
    dplyr::select(stat, pvalue, padj, gene) %>%
    dplyr::mutate(macrophages = macrophage)
})) %>%
  dplyr::mutate(direction = ifelse(stat<0, "HC", "CRC+"),
                significance = ifelse(pvalue<0.05, "Significant", "NS"),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  dplyr::left_join(macrophage_markers, by = "gene") %>%
  dplyr::filter(pvalue<0.05) %>%
  ggplot(aes(x = macrophages, y = gene)) +
  #geom_point(aes(size = -log10(pvalue), col = direction, alpha = significance)) +
  geom_tile(aes(fill = stat)) +
  facet_grid(set~., space = "free", scales = "free") +
  theme_bw() +
  scale_fill_gradient2(low = group_colors["HC"],
                       mid = "white",
                       high = group_colors["CRC+"],
                       midpoint = 0) +
  #scale_fill_viridis() +
  scale_alpha_manual(values = c("NS" = "#d3d3d3", "Significant" = "#000000")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#pdf("heatmap_crcpmpvhc_pf_l4_goi.pdf", width = 3.5, height = 20)
# pdf("heatmap_crcpmpvhc_pf_l4_goi.pdf", width = 3.5, height = 9)
# print(heatmap_crcpmpvhc_pf_l4_goi_ggplotobj)
# dev.off()
```

### Boxplot PM-CRC TX l2rl0 colored by l2

```{r boxplot hc pf l2rl0 col_l2, fig.width=7.5, fig.height=5}
boxplot_crcpmp_tx_l2rl0_ggplotobj <- seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l2, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l2), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_crcpmp_tx_immune@meta.data[,c("manual_l1", "manual_l2")]), by = "manual_l2") %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l2, -Ncellperc), y = Ncellperc, fill = manual_l2)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5) +
  scale_fill_manual(values = manual_l2_colors) +
  labs(y = "%CD45+ cells") +
  facet_grid(.~manual_l1, space = "free", scales = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmp_tx_l2rl0_ggplotobj)

pdf("boxplot_crcpmp_tx_l2rl0.pdf", width = 5, height=6)
print(boxplot_crcpmp_tx_l2rl0_ggplotobj)
dev.off()
```

### Boxplot PM-CRC TX l3rl0 colored by l3

```{r boxplot hc pf l3rl0 col_l3, fig.width=7.5, fig.height=5}
boxplot_crcpmp_tx_l3rl0_ggplotobj <- seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_crcpmp_tx_immune@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l3, -Ncellperc), y = Ncellperc, fill = manual_l3)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5) +
  scale_fill_manual(values = manual_l3_colors) +
  labs(y = "%CD45+ cells") +
  facet_grid(.~manual_l1, space = "free", scales = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmp_tx_l3rl0_ggplotobj)

pdf("boxplot_crcpmp_tx_l3rl0.pdf", width = 7.5, height=6)
print(boxplot_crcpmp_tx_l3rl0_ggplotobj)
dev.off()

seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_crcpmp_tx_immune@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  readr::write_csv("crcpmp_tx_immune_l3rl0.csv")
```

### Boxplot PM-CRC TX l4rl0 colored by l4

```{r boxplot hc pf l4rl0 col_l4, fig.width=15, fig.height=7.5}
boxplot_crcpmp_tx_l4rl0_ggplotobj <- seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_crcpmp_tx_immune@meta.data[,c("manual_l1", "manual_l4")]), by = "manual_l4") %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l4, -Ncellperc), y = Ncellperc, fill = manual_l4)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5) +
  scale_fill_manual(values = manual_l4_colors) +
  labs(y = "%CD45+ cells") +
  facet_grid(.~manual_l1, space = "free", scales = "free") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmp_tx_l4rl0_ggplotobj)

pdf("boxplot_crcpmp_tx_l4rl0.pdf", width = 7.5, height=6)
print(boxplot_crcpmp_tx_l4rl0_ggplotobj)
dev.off()

seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_crcpmp_tx_immune@meta.data[,c("manual_l1", "manual_l4")]), by = "manual_l4") %>%
  readr::write_csv("crcpmp_tx_immune_l4rl0.csv")
```

### Boxplot PM-CRC TX l4rl1

```{r boxplot crcpmp l4rl1, fig.width = 10, fig.height = 15}
seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l1, manual_l3, SampleID, Group, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l1, manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, manual_l1) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::ungroup() %>%
  readr::write_csv(file = "crcpmp_tx_immune_l4rl1.csv")
```

### Boxplot PM-CRC TX l4rl1 (Monomac)

```{r boxplot crcpmp l4rl1 monomac, fig.width = 10, fig.height = 15}
seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::mutate(manual_l1 = ifelse(manual_l2 %in% c("Macrophages", "Monocytes"), "Monomacs", manual_l1)) %>%
  dplyr::group_by(manual_l1, manual_l3, SampleID, Group, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l1, manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, manual_l1) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::ungroup() %>%
  readr::write_csv(file = "crcpmp_tx_immune_l4rl1_monomacs.csv")
```

### Boxplot PM-CRC TX l4rl2

```{r boxplot crcpmp l4rl2, fig.width = 8, fig.height = 3.5}
seurat_crcpmp_tx_immune@meta.data %>%
  dplyr::group_by(manual_l2, manual_l4, SampleID, Group, .drop = T) %>%
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l2, manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, manual_l2) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  readr::write_csv(file = "crcpmp_tx_immune_l4rl2.csv")
```

### Boxplot PM-CRC vs HC PF l3rl0 colored by group

```{r boxplot crcpmpvhc pf l3rl0 col_group, fig.width = 12.5, fig.height = 5}
boxplot_crcpmpvhc_pf_l3rl0_ggplotobj <- seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  dplyr::left_join(unique(seurat_hc_crcpmp_pf@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(dacs_pf_l3rl0_crcpmpvhc[[1]]$da, by = c("manual_l3" = "BaselineProp.clusters")) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l3, -Ncellperc), y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75), aes(group = Group)) +
  facet_grid(.~ manual_l1, scales = "free", space="free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l3rl0_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l3rl0.pdf", width = 12.5, height = 5)
# print(boxplot_crcpmpvhc_pf_l3rl0_ggplotobj)
# dev.off()
```

```{r boxplot crcpmpvhc pf l3rl0 col_group separate, fig.width = 10, fig.height = 12.5}
boxplot_crcpmpvhc_pf_l3rl0_separate_ggplotobj <- seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l3, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_hc_crcpmp_pf@meta.data[,c("manual_l1", "manual_l3")]), by = "manual_l3") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(dacs_pf_l3rl0_crcpmpvhc[[1]]$da, by = c("manual_l3" = "BaselineProp.clusters")) %>%
  dplyr::arrange(P.Value) %>%
  dplyr::mutate(label = paste0(manual_l3, "\np-value = ", formatC(P.Value, format = "e", digits = 3)),
                label = factor(label, levels = unique(label)),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  ggplot(aes(x = Group, y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~label, scales = "free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l3rl0_separate_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l3rl0_separate.pdf", width = 10, height = 12.5)
# print(boxplot_crcpmpvhc_pf_l3rl0_separate_ggplotobj)
# dev.off()
```

### Boxplot PM-CRC vs HC PF l4rl0 colored by group

```{r boxplot crcpmpvhc pf l4rl0 col_group, fig.width = 12.5, fig.height = 5}
boxplot_crcpmpvhc_pf_l4rl0_ggplotobj <- seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  dplyr::left_join(unique(seurat_hc_crcpmp_pf@meta.data[,c("manual_l1", "manual_l4")]), by = "manual_l4") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(dacs_pf_l4rl0_crcpmpvhc[[1]]$da, by = c("manual_l4" = "BaselineProp.clusters")) %>%
  ggplot(aes(x = forcats::fct_reorder(manual_l4, -Ncellperc), y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75), aes(group = Group)) +
  facet_grid(.~ manual_l1, scales = "free", space="free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l4rl0_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l4rl0.pdf", width = 12.5, height = 5)
# print(boxplot_crcpmpvhc_pf_l4rl0_ggplotobj)
# dev.off()
```

```{r boxplot crcpmpvhc pf l4rl0 col_group separate, fig.width=13, fig.height=15}
boxplot_crcpmpvhc_pf_l4rl0_separate_ggplotobj <-  seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l4, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(unique(seurat_hc_crcpmp_pf@meta.data[,c("manual_l1", "manual_l4")]), by = "manual_l4") %>%
  dplyr::mutate(manual_l1 = factor(manual_l1, levels = manual_l1_order)) %>%
  dplyr::left_join(dacs_pf_l4rl0_crcpmpvhc[[1]]$da, by = c("manual_l4" = "BaselineProp.clusters")) %>%
  dplyr::arrange(P.Value) %>%
  dplyr::mutate(label = paste0(manual_l4, "\np-value = ", formatC(P.Value, format = "e", digits = 3)),
                label = factor(label, levels = unique(label)),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  ggplot(aes(x = Group, y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~label, scales = "free") +
  labs(y = "%CD45+") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l4rl0_separate_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l4rl0_separate.pdf", width = 13, height = 15)
# print(boxplot_crcpmpvhc_pf_l4rl0_separate_ggplotobj)
# dev.off()
```

### Boxplot PM-CRC vs HC PF l3rl1 colored by group

```{r boxplot crcpmpvhc pf l3rl1 col_group separate, fig.width = 10, fig.height = 15}
boxplot_crcpmpvhc_pf_l3rl1_separate_ggplotobj <- seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l1, manual_l3, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l1, manual_l3), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, manual_l1) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(do.call(rbind, lapply(dacs_pf_l3rl1_crcpmpvhc, function(celltype){celltype$da})) %>%
                     dplyr::mutate(celltype = BaselineProp.clusters), 
                   by = c("manual_l3" = "celltype")) %>%
  dplyr::filter(!is.na(P.Value)) %>%
  dplyr::arrange(P.Value) %>%
  dplyr::mutate(label = paste0(manual_l3, "\nParent: ", manual_l1, "\np-value = ", formatC(P.Value, format = "e", digits = 3)),
                label = factor(label, levels = unique(label)),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  ggplot(aes(x = Group, y = Ncellperc)) +
  geom_boxplot( outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~label, scales = "free") +
  labs(y = "%parent") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l3rl1_separate_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l3rl1_separate.pdf", width = 10, height = 15)
# print(boxplot_crcpmpvhc_pf_l3rl1_separate_ggplotobj)
# dev.off()

# seurat_hc_crcpmp_pf@meta.data %>%
#   dplyr::group_by(manual_l1, manual_l3, SampleID, Group, .drop = T) %>% 
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l1, manual_l3), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(SampleID, manual_l1) %>%
#   dplyr::mutate(Nlrefsample = sum(Ncells),
#                 Ncellprop = Ncells/Nlrefsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
#   dplyr::left_join(do.call(rbind, lapply(dacs_pf_l3rl1_crcpmpvhc, function(celltype){celltype$da})) %>%
#                      dplyr::mutate(celltype = BaselineProp.clusters), 
#                    by = c("manual_l3" = "celltype")) %>%
#   dplyr::filter(!is.na(P.Value)) %>%
#   dplyr::arrange(P.Value) %>%
#   dplyr::ungroup() %>%
#   readr::write_csv(file = "crcpmpvhc_pf_l3rl1.csv")
```

### Boxplot PM-CRC vs HC PF l4rl2 colored by group

```{r boxplot crcpmpvhc pf l4rl2 col_group separate, fig.width = 8, fig.height = 3.5}
boxplot_crcpmpvhc_pf_l4rl2_separate_ggplotobj <- seurat_hc_crcpmp_pf@meta.data %>%
  dplyr::group_by(manual_l2, manual_l4, SampleID, Group, .drop = T) %>% 
  dplyr::summarise(Ncells = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l2, manual_l4), fill = list(Ncells = 0)) %>%
  dplyr::group_by(SampleID, manual_l2) %>%
  dplyr::mutate(Nlrefsample = sum(Ncells),
                Ncellprop = Ncells/Nlrefsample,
                Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
                Ncellperc = Ncellprop*100,
                Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
  dplyr::left_join(dacs_pf_l4rl2_crcpmpvhc$Macrophages$da %>%
                     dplyr::mutate(celltype = rownames(.)), by = c("manual_l4" = "celltype")) %>%
  dplyr::filter(!is.na(P.Value)) %>%
  dplyr::arrange(P.Value) %>%
  dplyr::mutate(label = paste0(manual_l4, "\nParent: ", manual_l2, "\np-value = ", formatC(P.Value, format = "e", digits = 3)),
                label = factor(label, levels = unique(label)),
                Group = factor(Group, levels = c("HC", "CRC+"))) %>%
  ggplot(aes(x = Group, y = Ncellperc)) +
  geom_boxplot(outlier.shape = NA, aes(col = Group)) +
  geom_point(position = position_dodge(width=0.75)) +
  facet_wrap(~label, nrow = 1, scales = "free") +
  labs(y = "%parent") +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l4rl2_separate_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l4rl2_separate.pdf", width = 10, height = 3.5)
# print(boxplot_crcpmpvhc_pf_l4rl2_separate_ggplotobj)
# dev.off()

# seurat_hc_crcpmp_pf@meta.data %>%
#   dplyr::group_by(manual_l2, manual_l4, SampleID, Group, .drop = T) %>% 
#   dplyr::summarise(Ncells = n()) %>%
#   dplyr::ungroup() %>%
#   tidyr::complete(tidyr::nesting(Group, SampleID), tidyr::nesting(manual_l2, manual_l4), fill = list(Ncells = 0)) %>%
#   dplyr::group_by(SampleID, manual_l2) %>%
#   dplyr::mutate(Nlrefsample = sum(Ncells),
#                 Ncellprop = Ncells/Nlrefsample,
#                 Ncellprop = ifelse(is.na(Ncellprop), 0, Ncellprop),
#                 Ncellperc = Ncellprop*100,
#                 Donor = gsub("^(pt[0-9]{2})_.+$", "\\1", SampleID)) %>%
#   dplyr::left_join(dacs_pf_l4rl2_crcpmpvhc$Macrophages$da %>%
#                      dplyr::mutate(celltype = rownames(.)), by = c("manual_l4" = "celltype")) %>%
#   dplyr::filter(!is.na(P.Value)) %>%
#   dplyr::arrange(P.Value) %>%
#   readr::write_csv(file = "crcpmpvhc_pf_l4rl2.csv")
```

### Dotplot GEX PM-CRC vs HC PF macrophages colored by macrophage marker DEGs

```{r dotplot gex crcpmpvhc pf macrophages col_degstop50, fig.width=3.5, fig.height=27.5}
crcpmpvhc_pf_macrophages_l4_top50 <- unique(unlist(lapply(degs_pf_l4_crcpmpvhc[macrophages_order_pf_l4$celltype], function(macrophage){
  macrophage$degs[1:50,"gene"]
})))

dotplot_gex_crcpmpvhc_pf_macrophages_degstop50_ggplotobj <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  degs_pf_l4_crcpmpvhc[[macrophage]]$degs %>%
    data.frame() %>%
    dplyr::filter(gene %in% crcpmpvhc_pf_macrophages_l4_top50) %>%
    dplyr::select(stat, pvalue, padj, gene) %>%
    dplyr::mutate(macrophages = macrophage)
})) %>%
  dplyr::mutate(direction = ifelse(stat<0, "HC", "CRC+"),
                significance = ifelse(pvalue<0.05, "Significant", "NS"),
                gene = factor(gene, levels = crcpmpvhc_pf_macrophages_l4_top50),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  ggplot(aes(x = macrophages, y = gene)) +
  geom_point(aes(size = -log10(pvalue), col = direction, alpha = significance)) +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(dotplot_gex_crcpmpvhc_pf_macrophages_degstop50_ggplotobj)

# pdf("dotplot_gex_crcpmpvhc_pf_macrophages_degstop50.pdf", width = 3.5, height = 27.5)
# print(dotplot_gex_crcpmpvhc_pf_macrophages_degstop50_ggplotobj)
# dev.off()
```

### Dotplot pathways PM-CRC vs HC PF macrophages colored by genesets that were significantly different in at least 1 macrophage subset

```{r dotplot pws crcpmpvhc pf macrophages col_pws, fig.width = 7.5, fig.height = 12.5}
crcpmpvhc_pf_macrophages_l4_fgsea_sig <- unique(unlist(lapply(fgsea_pf_l4_crcpmpvhc[macrophages_order_pf_l4$celltype], function(macrophage){
  macrophage %>%
    data.frame() %>%
    dplyr::select(1:7) %>%
    dplyr::filter(padj<0.05) %>%
    dplyr::pull(pathway)
})))

crcpmpvhc_pf_macrophages_l4_fgsea_sig_df <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  fgsea_pf_l4_crcpmpvhc[[macrophage]] %>%
    data.frame() %>%
    dplyr::filter(pathway %in% crcpmpvhc_pf_macrophages_l4_fgsea_sig) %>%
    dplyr::select(pathway, NES, pval, padj) %>%
    dplyr::mutate(macrophages = macrophage)
}))

dotplot_pwd_crcpmpvhc_pf_macrophages_colpws_ggplotobj <- crcpmpvhc_pf_macrophages_l4_fgsea_sig_df %>%
  #dplyr::filter(pathway %in% sig_pwoi) %>%
  dplyr::mutate(direction = ifelse(NES<0, "HC", "CRC+"),
                significance = ifelse(pval<0.05, "Significant", "NS"),
                pathway = factor(pathway, levels = unique(pathway)),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  ggplot(aes(x = macrophages, y = pathway)) +
  geom_point(aes(size = -log10(pval), col = direction, alpha = significance)) +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(dotplot_pwd_crcpmpvhc_pf_macrophages_colpws_ggplotobj)

# pdf("dotplot_pwd_crcpmpvhc_pf_macrophages_colpws.pdf", width = 7.5, height = 12.5)
# print(dotplot_pwd_crcpmpvhc_pf_macrophages_colpws_ggplotobj)
# dev.off()
```

```{r dotplot pws crcpmpvhc pf macrophages col_dpws, fig.width = 6.25, fig.height = 5}
dotplot_pwd_crcpmpvhc_pf_macrophages_coldpws_ggplotobj <- crcpmpvhc_pf_macrophages_l4_fgsea_sig_df %>%
  dplyr::filter(pathway %in% c("KEGG_OXIDATIVE_PHOSPHORYLATION",
                               "KEGG_T_CELL_RECEPTOR_SIGNALING_PATHWAY",
                               "KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION",
                               "KEGG_PATHWAYS_IN_CANCER",
                               "KEGG_CHEMOKINE_SIGNALING_PATHWAY",
                               "KEGG_JAK_STAT_SIGNALING_PATHWAY",
                               "KEGG_CYTOKINE_CYTOKINE_RECEPTOR_INTERACTION",
                               "KEGG_TOLL_LIKE_RECEPTOR_SIGNALING_PATHWAY",
                               "KEGG_FC_GAMMA_R_MEDIATED_PHAGOCYTOSIS",
                               "KEGG_TGF_BETA_SIGNALING_PATHWAY",
                               "KEGG_COLORECTAL_CANCER",
                               "KEGG_CELL_ADHESION_MOLECULES_CAMS",
                               "KEGG_MAPK_SIGNALING_PATHWAY")) %>%
  dplyr::mutate(direction = ifelse(NES<0, "HC", "CRC+"),
                significance = ifelse(pval<0.05, "Significant", "NS"),
                pathway = factor(pathway, levels = unique(pathway)),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  ggplot(aes(x = macrophages, y = pathway)) +
  geom_point(aes(size = -log10(pval), col = direction, alpha = significance)) +
  theme_bw() +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(dotplot_pwd_crcpmpvhc_pf_macrophages_coldpws_ggplotobj)

pdf("dotplot_pwd_crcpmpvhc_pf_macrophages_coldpws.pdf", width = 6.25, height = 5)
print(dotplot_pwd_crcpmpvhc_pf_macrophages_coldpws_ggplotobj)
dev.off()
```

```{r dotplot gex crcpmpvhc pf macrophages split_dpwoi, fig.width = 3.5, fig.height = 10}
pwoi_for_genes <- c("KEGG_CHEMOKINE_SIGNALING_PATHWAY",
                    "KEGG_TGF_BETA_SIGNALING_PATHWAY",
                    "KEGG_CYTOKINE_CYTOKINE_RECEPTOR_INTERACTION",
                    "KEGG_ANTIGEN_PROCESSING_AND_PRESENTATION",
                    "KEGG_COLORECTAL_CANCER",
                    "KEGG_PATHWAYS_IN_CANCER")

gs_hs <- msigdbr(species = "Homo sapiens", category = "C2", subcategory = "CP:KEGG")
gs_hs_list <- split(x = gs_hs$gene_symbol, f = gs_hs$gs_name)
genes_pwoi <- unique(unlist(gs_hs_list[pwoi_for_genes]))

genes_pwoi_de <- lapply(degs_pf_l4_crcpmpvhc[macrophages_order_pf_l4$celltype], function(macrophage){
  macrophage$degs %>%
    data.frame() %>%
    #$dplyr::filter(pvalue<0.05 & gene %in% genes_pwoi)
    dplyr::filter(padj<0.05 & gene %in% genes_pwoi)
})

genes_pwoi_de_sig <- unique(do.call(rbind, genes_pwoi_de)$gene)

genes_pwoi_bin <- data.frame(do.call(cbind, lapply(gs_hs_list[pwoi_for_genes], function(pwoi){genes_pwoi_de_sig %in% pwoi})))
rownames(genes_pwoi_bin) <- genes_pwoi_de_sig
colnames(genes_pwoi_bin) <- pwoi_for_genes

pwoi_pw <- data.frame(gene = rownames(genes_pwoi_bin), 
                      pathway = apply(genes_pwoi_bin, MARGIN = 1, function(gene){colnames(genes_pwoi_bin)[min(which(gene))]}))

dotplot_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  degs_pf_l4_crcpmpvhc[[macrophage]]$degs %>%
    data.frame() %>%
    dplyr::filter(gene %in% genes_pwoi_de_sig) %>%
    dplyr::select(stat, pvalue, padj, gene) %>%
    dplyr::mutate(macrophages = macrophage)
})) %>%
  dplyr::mutate(direction = ifelse(stat<0, "HC", "CRC+"),
                significance = ifelse(pvalue<0.05, "Significant", "NS"),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  dplyr::left_join(pwoi_pw, by = "gene") %>%
  ggplot(aes(x = macrophages, y = gene)) +
  geom_point(aes(size = -log10(pvalue), col = direction, alpha = significance)) +
  theme_bw() +
  facet_grid(pathway~., space = "free", scales = "free") +
  scale_color_manual(values = group_colors) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(dotplot_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj)

# pdf("dotplot_gex_crcpmpvhc_pf_macrophages_gpws.pdf", width = 3.5, height = 10)
# print(dotplot_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj)
# dev.off()
```

```{r heatmap gex crcpmpvhc pf macrophages split_dpwoi, fig.width = 3.5, fig.height = 9}
heatmap_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  degs_pf_l4_crcpmpvhc[[macrophage]]$degs %>%
    data.frame() %>%
    dplyr::filter(gene %in% genes_pwoi_de_sig) %>%
    dplyr::select(stat, pvalue, padj, gene) %>%
    dplyr::mutate(macrophages = macrophage)
})) %>%
  dplyr::mutate(direction = ifelse(stat<0, "HC", "CRC+"),
                significance = ifelse(pvalue<0.05, "Significant", "NS"),
                macrophages = factor(macrophages, levels = macrophages_order_pf_l4$celltype)) %>%
  dplyr::left_join(pwoi_pw, by = "gene") %>%
  ggplot(aes(x = macrophages, y = gene)) +
  #geom_point(aes(size = -log10(pvalue), col = direction, alpha = significance)) +
  geom_tile(aes(fill = stat, alpha = significance)) +
  theme_bw() +
  facet_grid(pathway~., space = "free", scales = "free") +
  scale_fill_gradient2(low = group_colors["HC"],
                       mid = "white",
                       high = group_colors["CRC+"],
                       midpoint = 0) +
  #scale_fill_viridis() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.pos = "right",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(heatmap_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj)

# pdf("heatmap_gex_crcpmpvhc_pf_macrophages_gpws.pdf", width = 3.5, height = 9)
# print(heatmap_gex_crcpmpvhc_pf_macrophages_gpws_ggplotobj)
# dev.off()
```


```{r boxplot gex crcpmpvhc pf l4 dpwoigoi, fig.width = 20, fig.height = 20}
degs_pf_l4_crcpmpvhc_m1m2_sig_genes <- unique(unlist(lapply(degs_pf_l4_crcpmpvhc[macrophages_order_pf_l4$celltype], function(macrophage){
  macrophage$degs %>%
    data.frame() %>%
    dplyr::filter(gene %in% c(m1_markers$HGNC, m2_markers$HGNC),
                  pvalue < 0.05) %>%
    dplyr::pull(gene)
})))

boxplot_crcpmpvhc_pf_l4_dpwoigoi_df <- do.call(rbind, lapply(macrophages_order_pf_l4$celltype, function(macrophage){
  assay(rlog(degs_pf_l4_crcpmpvhc[[macrophage]]$dds)) %>%
    data.frame(., gene = rownames(.)) %>%
    dplyr::filter(gene %in% degs_pf_l4_crcpmpvhc_m1m2_sig_genes) %>%
    tidyr::pivot_longer(-gene, names_to = "SampleID", values_to = "Expr") %>%
    dplyr::left_join(data.frame(colData(degs_pf_l4_crcpmpvhc[[macrophage]]$dds)), by = "SampleID") %>%
    dplyr::left_join(data.frame(degs_pf_l4_crcpmpvhc[[macrophage]]$degs), by = "gene") %>%
    dplyr::mutate(Group = factor(ifelse(Group == "CRCp", "CRC+", "HC"), levels = c("HC", "CRC+")),
                  macrophage = macrophage,
                  label = paste0(gene,"\n",macrophage,"\np=", formatC(pvalue, 3, format = "e")))
})) 

boxplot_crcpmpvhc_pf_l4_dpwoigoi_ggplotobj <- ggplot(boxplot_crcpmpvhc_pf_l4_dpwoigoi_df, aes(x = Group, y = Expr, col = Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point_rast(size = 1.5) +
  scale_color_manual(values = group_colors) +
  facet_wrap(~label, scales = "free") +
  labs(y = "log2(expr)") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmpvhc_pf_l4_dpwoigoi_ggplotobj)

# pdf("boxplot_crcpmpvhc_pf_l4_dpwoigoi.pdf", width = 20, height = 20)
# print(boxplot_crcpmpvhc_pf_l4_dpwoigoi_ggplotobj)
# dev.off()
# 
# boxplot_crcpmpvhc_pf_l4_dpwoigoi_df %>%
#   readr::write_csv(file = "crcpmpvhc_pf_l4_dpwoigoi.csv")
```

## Trajectory analysis monocytes macrophages PBMC, PF and TX

```{r pseudotime}
colData(crcpmp_pbmc_pf_tx_paired_monocytes_macrophages_trajectory_sce)$Pseudotime <- averagePseudotime(tscan_rootcl1) 
```

```{r entropy differential}
crcpmp_pf_tx_paired_macrophages_trajectory_coldata <- colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce) %>%
  data.frame() %>%
  dplyr::filter(manual_l2 != "Monocytes") %>%
  dplyr::mutate(Donor = as.factor(Donor),
                Tissue = as.factor(Tissue))

crcpmp_pf_tx_paired_macrophages_trajectory_coldata_split <- split(crcpmp_pf_tx_paired_macrophages_trajectory_coldata, crcpmp_pf_tx_paired_macrophages_trajectory_coldata$manual_l4)

crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt <- lapply(crcpmp_pf_tx_paired_macrophages_trajectory_coldata_split, function(macrophage){
  lmer_full <- lmer(entropy~Tissue+(1|Donor), data = macrophage)
  lmer_red <- lmer(entropy~(1|Donor), data = macrophage)
  lrt_results <- anova(lmer_full, lmer_red)
  return(lrt_results)
})

entropy_pvalues <- do.call(rbind, lapply(crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt, function(macrophage){
  macrophage$`Pr(>Chisq)`[2]
}))
colnames(entropy_pvalues) <- "pvalue" 

write.csv(entropy_pvalues, "crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt_pvalues.csv")
```

```{r boxplot crcpmpvhc pf tx monocytes macrophages entropy, fig.width = 5, fig.height = 5}
boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj <- data.frame(colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  ggplot(aes(x = manual_l4, y = entropy, col = Tissue)) +
  geom_point(position = position_jitterdodge(), alpha=0.3, size = 0.1) +
  geom_boxplot(outlier.shape = NA)+
  labs(y = "Entropy") +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj)

pdf("boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy.pdf", width = 5, height=5)
print(boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages col manuall4, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                      reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                      colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = celltype_w_number)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_monocytes_macrophages_number_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages col tissue, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                    reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                    colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Tissue)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = tissue_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue_ggplotobj)
dev.off()

```

```{r umap crcpmp pf tx paired monocytes macrophages colentropy, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                     reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                     colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  geom_point_rast(show.legend = T, size = 1, aes(col = entropy)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj)

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages colpseudotime, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                        reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                        colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Pseudotime)) +
  geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime_ggplotobj)
dev.off()

```

## Trajectory analysis monocytes macrophages PF and TX

```{r pseudotime}
colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)$Pseudotime <- averagePseudotime(tscan_rootcl1) 
```

```{r entropy differential}
crcpmp_pf_tx_paired_macrophages_trajectory_coldata <- colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce) %>%
  data.frame() %>%
  dplyr::filter(manual_l2 != "Monocytes") %>%
  dplyr::mutate(Donor = as.factor(Donor),
                Tissue = as.factor(Tissue))

crcpmp_pf_tx_paired_macrophages_trajectory_coldata_split <- split(crcpmp_pf_tx_paired_macrophages_trajectory_coldata, crcpmp_pf_tx_paired_macrophages_trajectory_coldata$manual_l4)

crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt <- lapply(crcpmp_pf_tx_paired_macrophages_trajectory_coldata_split, function(macrophage){
  lmer_full <- lmer(entropy~Tissue+(1|Donor), data = macrophage)
  lmer_red <- lmer(entropy~(1|Donor), data = macrophage)
  lrt_results <- anova(lmer_full, lmer_red)
  return(lrt_results)
})

entropy_pvalues <- do.call(rbind, lapply(crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt, function(macrophage){
  macrophage$`Pr(>Chisq)`[2]
}))
colnames(entropy_pvalues) <- "pvalue" 

write.csv(entropy_pvalues, "crcpmp_pf_tx_paired_macrophages_entropy_lmer_lrt_pvalues.csv")
```

```{r boxplot crcpmpvhc pf tx monocytes macrophages entropy, fig.width = 5, fig.height = 5}
boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj <- data.frame(colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  ggplot(aes(x = manual_l4, y = entropy, col = Tissue)) +
  geom_point(position = position_jitterdodge(), alpha=0.3, size = 0.1) +
  geom_boxplot(outlier.shape = NA)+
  labs(y = "Entropy") +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.x = element_blank(),
        legend.pos = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj)

pdf("boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy.pdf", width = 5, height=5)
print(boxplot_crcpmp_pf_tx_monocytes_macrophages_entropy_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages col manuall4, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                      reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                      colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = celltype_w_number)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  geom_label_repel(data = . %>%
                     dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
                     summarize(x = median(x = UMAP_1),
                               y = median(x = UMAP_2)),
                   mapping = aes(label = celltype_number, x = x, y = y),
                   alpha = 1,
                   size=8,
                   label.size=0.25,
                   show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = manual_l4_monocytes_macrophages_number_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colmanuall4_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages col tissue, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                    reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                    colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  #geom_encircle(aes(col = Tissue), expand = 0, s_shape=1, size = 2) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Tissue)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  scale_color_manual(values = tissue_colors) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_coltissue_ggplotobj)
dev.off()

```

```{r umap crcpmp pf tx paired monocytes macrophages colentropy, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                     reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                     colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  geom_point_rast(show.legend = T, size = 1, aes(col = entropy)) +
  #geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj)

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colentropy_ggplotobj)
dev.off()
```

```{r umap crcpmp pf tx paired monocytes macrophages colpseudotime, fig.width = 8, fig.height = 9}
umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime_ggplotobj <- data.frame(CB = colnames(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce),
                                                                                        reducedDim(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce , "UMAP"),
                                                                                        colData(crcpmp_pf_tx_paired_monocytes_macrophages_trajectory_sce)) %>%
  dplyr::mutate(celltype = factor(manual_l4, levels = celltype_order_l4_monocytes_macrophages$celltype),
                celltype_number = as.numeric(celltype),
                celltype_w_number = paste0(as.numeric(celltype), ". ", celltype),
                celltype_w_number = factor(celltype_w_number, levels = celltype_order_l4_monocytes_macrophages$number_subset)) %>% 
  ggplot(aes(x = UMAP_1, y = UMAP_2)) +
  geom_point_rast(show.legend = T, size = 1, aes(col = Pseudotime)) +
  geom_line(data = aggregated_lines, mapping=aes(x=UMAP_1, y=UMAP_2, group=edge)) +
  labs(y = "",
       x = "") +
  # geom_label_repel(data = . %>%
  #                    dplyr::group_by(celltype, celltype_number, celltype_w_number) %>%
  #                    summarize(x = median(x = UMAP_1),
  #                              y = median(x = UMAP_2)),
  #                  mapping = aes(label = celltype_number, x = x, y = y),
  #                  alpha = 1,
  #                  size=8,
  #                  label.size=0.25,
  #                  show.legend = F) +
  guides(colour = guide_legend(override.aes = list(size = 3))) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        strip.text.x = element_text(face = "bold"))

pdf("umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime.pdf", width = 5, height=5.5)
print(umap_crcpmp_pf_tx_paired_monocytes_macrophages_l4_colpseudotime_ggplotobj)
dev.off()

```

### Radarplot PM-CRC PF TX Macrophages median TAM classification

```{r radarplot crcpmp pf macrophages median tam classification, fig.width = 6, fig.height = 5}
radarplot_crcpmp_pf_tx_macrophages_mediantamclassification_splitl4_ggplotobj <- crcpmp_pf_tx_paired_macrophages_tamannotation %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell") %>%
  dplyr::group_by(Tissue, manual_l4, TAM) %>%
  dplyr::summarize(median_UCell = median(UCell)) %>%
  dplyr::mutate(TAM = factor(TAM, levels = c("Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM"))) %>%
  ggplot(aes(x = TAM, y = median_UCell, col = Tissue, group = Tissue)) +
  geom_point() +
  geom_encircle(expand = 0, s_shape=1, size = 2) +
  #geom_polygon(fill=NA, stat = "identity", linewidth = 1.3) +  
  #geom_path() +
  facet_wrap(~manual_l4) +
  scale_color_manual(values = tissue_colors) +
  labs(y = "Median UCell Score") +
  coord_polar() +
  theme_bw() +
  theme(legend.title = element_blank(),
        axis.title.x = element_blank())

pdf("radarplot_crcpmp_pf_tx_macrophages_mediantamclassification_splitl4.pdf", width = 9, height=10)
print(radarplot_crcpmp_pf_tx_macrophages_mediantamclassification_splitl4_ggplotobj)
dev.off()
```

### Jitteredboxplot PM-CRC PF TX Macrophages median TAM classification

```{r jitteredboxplot crcpmp pf tx paired macrophages tam classification, fig.width = 15, fig.height = 3.5}
jitteredboxplot_crcpmp_pf_tx_paired_macrophages_tamclassification_ggplotobj <- crcpmp_pf_tx_paired_macrophages_tamannotation %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell Score") %>%
  ggplot(aes(x = TAM, y = `UCell Score`, col = Tissue)) +
  geom_point_rast(position = position_jitterdodge(), alpha = 0.3, size = 0.1) +
  #geom_jitter_rast() +  
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~manual_l4, nrow = 1) +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(legend.pos = "bottom",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(jitteredboxplot_crcpmp_pf_tx_paired_macrophages_tamclassification_ggplotobj)

pdf("jitteredboxplot_crcpmp_pf_tx_paired_macrophages_tamclassification.pdf", width = 15, height=3.5)
print(jitteredboxplot_crcpmp_pf_tx_paired_macrophages_tamclassification_ggplotobj)
dev.off()
```

```{r jitteredboxplot crcpmp pf tx paired macrophages c1qspp1 tam classification}
jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamclassification_ggplotobj <- crcpmp_pf_tx_paired_macrophages_tamannotation %>%
  dplyr::filter(manual_l4 == "Macrophages C1Q+SPP1+") %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell Score") %>%
  ggplot(aes(x = TAM, y = `UCell Score`, col = Tissue)) +
  geom_point_rast(position = position_jitterdodge(), alpha = 0.3, size = 0.1) +
  #geom_jitter_rast() +  
  geom_boxplot(outlier.shape = NA) +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(legend.pos = "bottom",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pdf("jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamclassification.pdf", width = 5, height=5)
print(jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamclassification_ggplotobj)
dev.off()
```

```{r jitteredboxplot crcpmp pf tx paired macrophages c1qspp1 tam classification}
jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamregclassification_ggplotobj <- crcpmp_pf_tx_paired_macrophages_tamannotation %>%
  dplyr::filter(manual_l4 == "Macrophages C1Q+SPP1+") %>%
  dplyr::select(c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4", "Angio", "IFN", "INFLAM", "LA", "Prolif", "Reg", "RTM")) %>%
  tidyr::pivot_longer(-c("CellID", "SampleID", "Donor", "Tissue", "manual_l1", "manual_l2", "manual_l3", "manual_l4"), names_to = "TAM", values_to = "UCell Score") %>%
  dplyr::filter(TAM == "Reg") %>%
  ggplot(aes(x = TAM, y = `UCell Score`, col = Tissue)) +
  geom_point_rast(position = position_jitterdodge(), alpha = 0.3, size = 0.1) +
  #geom_jitter_rast() +  
  geom_boxplot(outlier.shape = NA) +
  scale_color_manual(values = tissue_colors) +
  theme_bw() +
  theme(legend.pos = "bottom",
        legend.title = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

pdf("jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamregclassification.pdf", width = 3, height=5)
print(jitteredboxplot_crcpmp_pf_tx_paired_macrophagesc1qspp1_tamregclassification_ggplotobj)
dev.off()
```



```{r}
crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_coldata <- crcpmp_pf_tx_paired_macrophages_tamannotation %>%
  data.frame() %>%
  tidyr::pivot_longer(-c(1:51), names_to = "TAM", values_to = "UCell") %>%
  dplyr::filter(manual_l2 != "Monocytes") %>%
  dplyr::mutate(Macrophage_TAM = paste0(manual_l4, "_", TAM),
                Donor = as.factor(Donor),
                Tissue = as.factor(Tissue))

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_coldata_split <- split(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_coldata, crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_coldata$Macrophage_TAM)

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_lmer_lrt <- lapply(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_coldata_split, function(macrophagetam){
  lmer_full <- lmer(UCell~Tissue+(1|Donor), data = macrophagetam)
  lmer_red <- lmer(UCell~(1|Donor), data = macrophagetam)
  lrt_results <- anova(lmer_full, lmer_red)
  return(lrt_results)
})

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_pvalues <- do.call(rbind, lapply(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_lmer_lrt, function(macrophagetam){
  unlist(macrophagetam$`Pr(>Chisq)`[2])
}))

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell <- data.frame(pvalue = crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_pvalues[,1],
                                                                                   row.names =names(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_pvalues[,1]))

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell$padj <- p.adjust(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell$pvalue, method = "fdr")

crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell <- crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell[order(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell$pvalue),]

write.csv(crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell, "crcpmp_pf_tx_paired_macrophages_macrophages_tamclassification_ducell.csv")
```

```{r volcanoplot crcpmp txvpf paired macrophages c1qspp1 regtam}
reg_tam_markers <- readxl::read_excel(tam_markers_xlsx) %>%
  dplyr::filter(TAM == "Reg")

volcanoplot_crcpmp_txvpf_paired_macrophages_c1qspp1_regtammarkers_ggplotobj <- txvpf_paired_degs_l4$`Macrophages C1Q+SPP1+`$degs %>%
  data.frame() %>%
  dplyr::filter(gene %in% reg_tam_markers$Gene) %>%
  dplyr::mutate(Significance = ifelse(padj<0.05, "Significant", "NS"),
                label = ifelse(padj<0.05, gene, NA)) %>%
  ggplot(aes(x = log2FoldChange, y = -log10(pvalue))) +
  geom_vline(xintercept = 0, alpha = 0.5) +
  geom_hline(yintercept = 0, alpha = 0.5) +
  geom_point_rast(aes(col = Significance)) +
  # geom_point_rast(data = . %>%
  #                   dplyr::filter(gene %in% reg_tam_markers$Gene), col = "red") +
  geom_label_repel(aes(label = label)) +
  scale_color_manual(values = c("Significant" = "#000000", "NS" = "#d3d3d3")) +
  labs(title = "PM relative to PF from paired patients",
       subtitle = "Reg-TAM markers",
       y = bquote('-'~log[10]~'(p-value)'),
       x = bquote('-'~log[2]~'(fold change)')) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.pos = "bottom")

pdf("volcanoplot_crcpmp_txvpf_paired_macrophages_c1qspp1_regtammarker.pdf", width = 5, height = 6)
print(volcanoplot_crcpmp_txvpf_paired_macrophages_c1qspp1_regtammarkers_ggplotobj)
dev.off()
```

